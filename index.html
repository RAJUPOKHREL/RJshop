<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Elite Shop Manager Pro - Version 11.0</title>
    
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style> 
    /* 1. TARGETING THE OPTIONS DROPDOWN & SELECT BOXES */
    select, 
    option, 
    .options-btn, 
    .options-menu,
    [class*="options"] { 
        background: transparent !important; 
        background-color: transparent !important;
        color: white !important; 
        border: 1px solid rgba(255, 255, 255, 0.3) !important;
        backdrop-filter: none !important;
        -webkit-appearance: none; 
    }

    select option { 
        background: rgba(0, 0, 0, 0.8) !important; 
        color: white !important; 
    }

    :root { 
        --primary: #77777777; 
        --success: #10b981; 
        --danger: #ef4444; 
        --warning: #f59e0b; 
    }

    /* 2. THE WALLPAPER */
    html, body { 
        margin: 0; padding: 0; min-height: 100vh;
        background: linear-gradient(rgba(0, 0, 0, 0.65), rgba(0, 0, 0, 0.65)), 
                    url('https://raw.githubusercontent.com/RAJUPOKHREL/RJshop/refs/heads/main/5153888%20(1).jpg') 
                    no-repeat center center fixed !important;
        background-size: cover !important;
        font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
        padding-bottom: 120px; color: white; -webkit-tap-highlight-color: transparent;
    }

    /* 3. HEADER & FLOATING PILL NAV */
    .header { padding: 15px 20px; background: transparent !important; backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255, 255, 255, 0.1); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; }

    .bottom-nav { 
        position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; height: 70px; 
        background: rgba(0, 0, 0, 0.7) !important; backdrop-filter: blur(25px); display: flex; justify-content: space-around; 
        align-items: center; border: 1px solid rgba(255, 255, 255, 0.1) !important; z-index: 1000; border-radius: 40px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    .nav-item { background: transparent !important; border: none !important; color: rgba(255, 255, 255, 0.6) !important; padding: 10px 15px; display: flex; flex-direction: column; align-items: center; transition: 0.3s; font-size: 12px; }
    .nav-item.active { color: white !important; background: rgba(255, 255, 255, 0.15) !important; border-radius: 20px; }

    /* 4. CARDS */
    .card, .dash-dark-card, .report-summary-card, .date-pager { 
        background: rgba(255, 255, 255, 0.03) !important; 
        backdrop-filter: none !important; 
        border: 1px solid rgba(255, 255, 255, 0.1) !important; 
        padding: 18px; border-radius: 20px; margin-bottom: 15px; box-sizing: border-box; overflow: hidden;
    }

    /* 5. PAGER CONTROLS */
    .pager-controls { 
        display: flex !important; 
        flex-direction: row !important; 
        align-items: center !important; 
        justify-content: space-between !important; 
        gap: 10px; 
    }
    .pager-controls span { 
        flex: 1; 
        text-align: center; 
        font-weight: 800; 
        font-size: 14px; 
    }
    .prev-btn, .next-btn { width: auto !important; flex: 0 0 auto !important; }

    /* 6. BUTTONS (ELITE TRANSPARENT) */
    .action-btn, .date-pager button, .control-panel button, #pull-btn, .prev-btn, .next-btn { 
        background: transparent !important; 
        color: white !important; 
        box-shadow : 0 4px 15px rgba(0,0,0,0.3);
        border: 1px solid rgba(255, 255, 255, 0.3) !important; 
        padding: 12px 18px; border-radius: 12px; font-weight: 800; cursor: pointer;
        transition: 0.3s ease;
    }

    /* CENTER MAIN ACTION BUTTONS */
    .action-btn, #save-inv-btn {
        display: block !important;
        width: 80% !important; 
        margin: 20px auto !important; 
        position: static !important;
        transform: none !important;
        left: auto !important;
        text-align: center !important;
    }

    /* CLEAN BACKUP BUTTON (REPLACED SOLID WHITE WITH ELITE STYLE) */
    #generate-pdf-btn {
        background: rgba(255, 255, 255, 0.05) !important; /* Glass effect, not solid white */
        color: white !important; 
        border: 1px solid rgba(255, 255, 255, 0.2) !important;
        box-shadow : 0 4px 15px rgba(0,0,0,0.3);
        
        /* Positioning logic kept same as your requested clean look */
        display: block !important;
        width: 90% !important;   
        max-width: 350px;         
        margin: 25px auto !important; 
        position: static !important;
        transform: none !important;
        left: auto !important;

        padding: 15px 20px !important;  
        font-size: 14px !important;      
        font-weight: 800 !important;
        line-height: 1.3 !important;
        text-align: center !important;
        border-radius: 15px !important;
        cursor: pointer;
        text-transform: uppercase;
    }

    /* 7. GRID & INPUTS */
    .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px; }
    .mini-stat { 
        padding: 20px; border-radius: 22px; display: flex; flex-direction: column;
        background: rgba(255, 255, 255, 0.05) !important; border: 1px solid rgba(255, 255, 255, 0.1) !important;
    }
    .mini-stat strong { font-size: 24px; font-weight: 900; }
    
    input, select, textarea { 
        width: 100% !important; box-sizing: border-box !important; padding: 16px; margin-bottom: 12px; border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.2) !important; background: transparent !important; color: white !important;
    }

    /* 8. TAB LOGIC & UTILS */
    .hidden { display: none !important; }
    .container { padding: 15px; max-width: 600px; margin: auto; }
    h1, h2, h3, strong, label { color: white !important; }

    .sub-nav { display: flex; gap: 8px; margin-bottom: 15px; background: rgba(255,255,255,0.05); padding: 6px; border-radius: 15px; }
    .sub-nav button { flex: 1; border: none; padding: 12px; border-radius: 10px; font-weight: 700; color: white; opacity: 0.5; background: none; }
    .sub-nav button.active { background: var(--primary); opacity: 1; }

    .sales-row { display: flex; gap: 12px; width: 100%; margin-bottom: 5px; }
    .sales-row > div { flex: 1; }

    input[type="checkbox"] { width: 30px !important; height: 30px !important; cursor: pointer; accent-color: var(--success); vertical-align: middle; }

    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .spinning { display: inline-block; animation: spin 0.5s linear infinite; }

    /* MOBILE SLIDING TABS */
    .sub-nav, .tab-bar, .sub-tabs {
        display: flex !important;
        flex-wrap: nowrap !important;
        overflow-x: auto !important; 
        -webkit-overflow-scrolling: touch;
        gap: 10px !important;
        padding: 10px 5px !important;
        justify-content: flex-start !important;
        scrollbar-width: none;
    }
    .sub-nav::-webkit-scrollbar { display: none; }
    .sub-nav button { flex: 0 0 auto !important; min-width: 100px; text-align: center; white-space: nowrap; }
    .container { overflow-x: hidden; }
	/* Add this to your CSS */
button, input, select, .card, .tab-btn {
    touch-action: manipulation;
}

body {
    touch-action: pan-x pan-y; /* Allows scrolling but blocks double-tap zoom */
}
button {
    -webkit-user-select: none; /* Safari */
    user-select: none;         /* Standard */
}
input, select, textarea {
    font-size: 16px !important;
}
.privacy-hidden {
    filter: blur(5px);
    pointer-events: none;
    user-select: none;
}
</style>
</head>
<body>

<div class="header">
    <h1 style="font-size: 22px; margin:0; font-weight: 950; letter-spacing: -1.2px;">ELITE SHOP PRO</h1>
    <div style="display:flex; align-items:center; gap:15px;">
        <button onclick="syncFromCloud()">
    <span id="pull-icon" style="display:inline-block;">üîÑ</span> Pull Data
</button>
        <div class="status-dot" id="sync-dot"></div>
    </div>
</div>

<div class="container">
    
    <section id="dashboard">
	
        <div class="stat-grid">
            <div class="mini-stat" style="background: var(--primary);">
                <small>Today's Sales</small>
                <strong id="dash-sales">$0.00</strong>
            </div>
            <div class="mini-stat" style="background: var(--success);">
                <small>Today's Profit</small>
                <strong id="dash-profit">$0.00</strong>
            </div>
        </div>

        <div class="dash-dark-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin: 0; color: var(--warning); font-size: 13px; text-transform: uppercase; letter-spacing: 1px;">Shop Overview</h3>
                <span class="calendar-icon" onclick="toggleDashFilter()">üìÖ Range</span>
            </div>

            <div id="dash-filter-area" class="dash-filter-container hidden">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div><label>From</label><input type="date" id="dash-from" onchange="refreshDashboardMetrics()"></div>
                    <div><label>To</label><input type="date" id="dash-to" onchange="refreshDashboardMetrics()"></div>
                </div>
                <button onclick="clearDashFilter()" style="width:100%; border:none; padding:8px; border-radius:8px; background:var(--danger); color:white; font-size:10px; font-weight:900;">CLEAR FILTER</button>
            </div>

           <div style="display:flex; flex-direction:column; gap:12px; font-size:14px;">
		   <div style="text-align: right; padding: 10px;">
    <button onclick="togglePrivacy()" style="background:none; border:none; cursor:pointer; font-size:20px;">
        <span id="privacy-icon">üëÅÔ∏è</span>
    </button>
</div>
    
    <div style="display:flex; justify-content:space-between;">
        <span style="opacity:0.8">Total Stock Invested:</span> 
        <span id="fin-total-invest" class="privacy-target" style="font-weight:700">$0.00</span>
    </div>

    <div style="display:flex; justify-content:space-between;">
        <span style="opacity:0.8">Inventory Value (Remaining):</span> 
        <span id="fin-invest"  class="privacy-target" style="font-weight:700">$0.00</span>
    </div>

    <hr style="opacity:0.1; margin: 5px 0;">

    <div style="display:flex; justify-content:space-between;">
        <span style="opacity:0.8">Service Expense:</span> 
        <span id="fin-serv-exp" style="color:#ff6b6b; font-weight:700">$0.00</span>
    </div>

    <div style="display:flex; justify-content:space-between;">
        <span style="opacity:0.8">General Expense:</span> 
        <span id="fin-gen-exp" style="color:#ff6b6b; font-weight:700">$0.00</span>
    </div>

    <div style="display:flex; justify-content:space-between;">
        <span style="opacity:0.8">Total Revenue:</span> 
        <span id="fin-earn" class="privacy-target" style="color:var(--success); font-weight:700">$0.00</span>
    </div>
	<div style="display:flex; justify-content:space-between;">
    <span style="opacity:0.8">Service/Repair Profit:</span> 
    <span id="fin-service-profit" class="privacy-target" style="color:var(--success); font-weight:700">$0.00</span>
</div>

    <div style="display:flex; justify-content:space-between; background: rgba(33, 150, 243, 0.1); padding: 10px; border-radius: 8px; margin-top: 5px;">
        <span style="opacity:0.8; font-weight:bold;">Cash in Hand:</span> 
        <span id="dash-cash" class="privacy-target"  style="font-weight:900; color: var(--success);">$0.00</span>
    </div>

    <hr style="opacity:0.15; margin: 10px 0;">

    <div style="display:flex; justify-content:space-between; align-items: center;">
        <span style="font-weight:700; font-size: 14px;">NET PROFIT:</span> 
        <span id="fin-net" class="privacy-target" style="font-weight:950; font-size:26px; color:var(--success)">$0.00</span>
    </div>
</div>
        </div>
        
        <button id="generate-pdf-btn" onclick="generatePDF()">Generate System Backup (.json)</button>
    </section>

    <section id="sales-entry" class="hidden">
        <div class="card">
            <label>Transaction Date</label>
            <input type="date" id="sale-date">
            
            <label>Transaction Category</label>
            <select id="sale-cat" onchange="updateEntryUIVisibility()">
                <option value="Accessory">Product/Stock Sale</option>
                <option value="Phone">Phone Sale</option>
                <option value="Repair">Repair / Service</option>
                <option value="ServiceExpense">Service Expense (Unlock Tools/Credits)</option>
                <option value="Pawn">Pawn Entry</option>
                <option value="Expense">Expense / Bill</option>
            </select>

    <div id="ui-standard">
    <label>Find Item in Stock</label>
    <input list="stock-datalist" id="sale-item-name" oninput="handleSaleAutoFill()" placeholder="Search product name...">
    
    <label>Add Promo/Gifts (Multi-Select)</label>
    <input list="stock-datalist" id="sale-promo-search" oninput="addGiftTag(this, 'sale-gift-container')" placeholder="Type to add gifts...">
    
    <div id="sale-gift-container" style="display:flex; flex-wrap:wrap; gap:8px; margin-top:8px;"></div>

    <datalist id="stock-datalist"></datalist>

    <div style="display:flex; gap:12px; align-items: flex; margin-top:10px;">
        <div style="flex:1;"><label>Quantity</label><input type="number" id="sale-qty" value="1"></div>
        <div style="flex:2;">
            <label>Selling Price</label>
            <input type="number" id="sale-price">
            <div class="check-group">
                <input type="checkbox" id="sale-per-unit">
                <label for="sale-per-unit">Per Unit</label>
            </div>
        </div>
    </div>
</div>
            <div id="ui-repair" class="hidden">
			<label>customer name</label>
				<input type="text" id="rep-customer" placeholder="Customer Name (Optional)" style="margin-top:5px;">
                <label>Model</label>
                <input type="text" id="rep-desc" placeholder="Device Model & Fault">
				<label>Error / Problem</label>
    <input type="text" id="rep-error" placeholder="e.g. LCD Replacement / Water Damage">
	<label>Promo / Add-on Item</label>
<input list="stock-datalist" id="rep-promo-item" placeholder="Select Item (e.g. Glass)">
	<label>Part Used (Parts Inventory Only)</label>
    <input list="parts-datalist" id="rep-part-name" placeholder="Search Part (511, Y91...)" onchange="autoFillRepairPart()">
    <datalist id="parts-datalist"></datalist>
                <div style="display:flex; gap:12px;">
                    <div style="flex:1;"><label>Parts Cost</label><input type="number" id="rep-cost" placeholder="0.00"></div>
                    <div style="flex:1;"><label>Price Charged</label><input type="number" id="rep-charge" placeholder="0.00"></div>
                </div>
            </div>

            <div id="ui-pawn" class="hidden">
                <label>Pawn Item / Customer Name</label>
                <input type="text" id="pawn-info" placeholder="Name - Model - ID">
                <div style="display:flex; gap:12px;">
                    <div style="flex:1;"><label>Loan Amount</label><input type="number" id="pawn-loan" placeholder="0.00"></div>
                    <div style="flex:1;"><label>Interest Fee</label><input type="number" id="pawn-interest" placeholder="0.00"></div>
                </div>
            </div>

            <div id="ui-expense" class="hidden">
                <label>Reason / Item Name</label>
                <input type="text" id="exp-name" placeholder="Unlock Tool, Credits, Rent, Electricity...">
                <label>Total Amount Paid</label>
                <input type="number" id="exp-amount" placeholder="0.00">
            </div>

            <button class="action-btn" onclick="processTransaction()">SAVE TRANSACTION</button>
        </div>
    </section>

    <section id="inventory" class="hidden">
        <div class="sub-nav">
            <button id="inv-tab-acc" class="active" onclick="switchInventorySubTab('acc')">STOCKS</button>
            <button id="inv-tab-phone" onclick="switchInventorySubTab('phone')">PHONES</button>
			<button id="inv-tab-Parts" onclick="switchInventorySubTab('Parts')">Repair Parts</button>
            <button id="inv-tab-pawn" onclick="switchInventorySubTab('pawn')">PAWNS</button>
            <button id="inv-tab-add" onclick="switchInventorySubTab('add')">+ NEW ENTRY</button>
        </div>

        <div id="inv-list-container">
            <input type="text" id="inv-search-box" placeholder="üîç Search stock items..." onkeyup="refreshInventoryDisplay()">
            <div id="inv-render-target"></div>
        </div>

        <div id="inv-add-container" class="hidden">
            <div class="card">
                <label>Item Category Type</label>
                <select id="add-main-type" onchange="updateAddStockUIVisibility()">
                    <option value="Accessory">Accessory / General Product</option>
                    <option value="Phone">Smartphone / Tablet</option>
					<option value="Parts">Parts</option>
                </select>

                <div id="add-form-accessory">
                    <label>Sub-Type / Brand</label>
                    <select id="add-sub-select" onchange="handleCustomCategoryToggle()">
                        <option>V8 Cable</option>
                        <option>Type-C Cable</option>
                        <option>Earphone</option>
                        <option>Airpods</option>
                        <option>Charger</option>
                        <option value="CUSTOM">-- WRITE CUSTOM CATEGORY --</option>
                    </select>
                    <input type="text" id="add-custom-cat-input" list="all-stock-names" class="hidden" placeholder="Type name to search or add new...">
<datalist id="all-stock-names"></datalist>
					<datalist id="learned-categories"></datalist>
                </div>

                <div id="add-form-phone" class="hidden">
                    <label>Device Condition</label>
                    <select id="add-phone-condition">
                        <option>Brand New</option>
                        <option>Second Hand</option>
                        <option>Refurbished</option>
                    </select>
                    <label>Hardware Specifications</label>
                    <input type="text" id="add-phone-specs" placeholder="e.g. 8GB/256GB - Blue">
                </div>

                <label>Full Product Name</label>
                <input type="text" id="add-item-name">
                
                <div style="display:flex; gap:12px;">
                    <div style="flex:1;"><label>Buy Price</label><input type="number" id="add-buy-price" placeholder="0.00"></div>
                    <div style="flex:1;"><label>Sell Price</label><input type="number" id="add-sell-price" placeholder="0.00"></div>
                </div>
                
                <label>Starting Quantity</label>
                <input type="number" id="add-stock-qty" value="1">

                <button class="action-btn" onclick="saveNewStockItem()">ADD TO INVENTORY</button>
            </div>
        </div>
    </section>

    <section id="records" class="hidden">
        <div class="date-pager">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <b id="pager-mode-title" style="font-size:11px; color:var(--primary)">DAILY VIEW</b>
                <button onclick="toggleReportMode()" style="font-size:10px; border:none; background:#eee; padding:5px 10px; border-radius:5px; font-weight:bold;">SWITCH RANGE</button>
            </div>
            
            <div id="pager-daily" class="pager-controls">
                <button class="pager-btn" onclick="changeReportDate(-1)">‚Üê PREV</button>
                <input type="date" id="report-date-input" style="margin:0; flex:1;" onchange="refreshReportDisplay()">
                <button class="pager-btn" onclick="changeReportDate(1)">NEXT ‚Üí</button>
            </div>

            <div id="pager-range" class="range-controls hidden">
                <input type="date" id="rep-from" onchange="refreshReportDisplay()">
                <input type="date" id="rep-to" onchange="refreshReportDisplay()">
            </div>
			
        </div>

        <div class="sub-nav">
            <button id="rep-all-btn" class="active" onclick="setReportFilter('All')">ALL</button>
            <button onclick="setReportFilter('Repair')">REPAIRS</button>
            <button onclick="setReportFilter('ServiceExpense')">SVC EXP</button>
            <button onclick="setReportFilter('Accessory')">STOCKS</button>
            <button onclick="setReportFilter('Expense')">GENERAL</button>
        </div>

        <div id="report-financial-summary" class="report-summary-card"></div>
        <div id="report-items-list"></div>
    </section>
	<section id="detailed-view" class="hidden">
    <div style="display:flex; align-items:center; gap:15px; margin-bottom:20px;">
        <button onclick="closeDetailsView()" style="background:none; border:1px solid white; color:white; padding:5px 15px; border-radius:10px;">‚Üê Back</button>
        <h2 id="detail-title" style="margin:0; font-size:18px;">Item Details</h2>
    </div>
    <div id="detail-list"></div>
</section>
</div>

<nav class="bottom-nav">
    <button class="nav-item active" id="btn-das" onclick="changeGlobalTab('dashboard')"><span>üè†</span>Dash</button>
    <button class="nav-item" id="btn-sal" onclick="changeGlobalTab('sales-entry')"><span>‚ûï</span>Sale</button>
    <button class="nav-item" id="btn-inv" onclick="changeGlobalTab('inventory')"><span>üì¶</span>Stock</button>
    <button class="nav-item" id="btn-rec" onclick="changeGlobalTab('records')"><span>üìä</span>Report</button>
</nav>

<script>
    const CLOUD_URL = "https://script.google.com/macros/s/AKfycbx-WiIzIzSlALp5EB3O9RUDHNRTb56J7F-Xa4i-931xT89tZbmT_WzACV2bFH3rxnQz/exec";
    const db = new Dexie("EliteShop_Pro_V11_Final");
    
   db.version(1).stores({ 
        records: '++id, date, cat, item, buy, sell, status, qty',
        inventory: '++id, type, sub, name, buy, sell, qty, specs, cond'
    });

    let currentReportFilter = 'All';
    let reportViewMode = 'daily';
    const getFormattedToday = () => new Date().toISOString().split('T')[0];
	
  let selectedGifts = [];

function addGiftTag(inputEl, containerId) {
    const val = inputEl.value;
    if(!val) return;

    // Check if the typed value matches an item in your stock-datalist
    const options = document.getElementById('stock-datalist').options;
    let foundInList = false;
    for (let i = 0; i < options.length; i++) {
        if (val === options[i].value) {
            foundInList = true;
            break;
        }
    }

    // ONLY create the bubble if the item is actually selected from the list
    if (foundInList) {
        if (selectedGifts.includes(val)) {
            inputEl.value = ''; // Don't add same gift twice
            return;
        }

        selectedGifts.push(val);
        const container = document.getElementById(containerId);
        
        // Create the "Bubble" (Tag)
        const tag = document.createElement('div');
        // This style makes it look like a nice button/bubble
        tag.style = "background:var(--primary); color:white; padding:6px 12px; border-radius:20px; display:flex; align-items:center; gap:8px; font-size:12px; border:1px solid rgba(255,255,255,0.3);";
        tag.innerHTML = `
            ${val} 
            <b onclick="removeGiftTag(this, '${val.replace(/'/g, "\\'")}')" style="cursor:pointer; color:#ff4444; font-size:16px; padding-left:5px;">√ó</b>
        `;

        container.appendChild(tag);
        
        // CLEAR the input immediately so the list is ready for the next gift
        inputEl.value = '';
    }
}

function removeGiftTag(element, name) {
    element.parentElement.remove();
    selectedGifts = selectedGifts.filter(g => g !== name);
}
    // DASHBOARD RANGE LOGIC
    function toggleDashFilter() {
        document.getElementById('dash-filter-area').classList.toggle('hidden');
    }
    function clearDashFilter() {
        document.getElementById('dash-from').value = "";
        document.getElementById('dash-to').value = "";
        refreshDashboardMetrics();
    }

    // CLOUD SYNC LOGIC
   async function syncToCloud() {
    const dot = document.getElementById('sync-dot');
    dot.style.background = 'orange'; 
    try {
        const records = await db.records.toArray();
        const inventory = await db.inventory.toArray();
        
        // 1. We create the first row containing your Stocks (Inventory)
        // We use a "type" tag so the load function knows this row is special
        let payload = [[JSON.stringify({ type: 'inventory_header', inventory })]];
        
        // 2. We push every single sale record into its own row
        // This spreads the data out so Google Cells never hit their limit
        records.forEach(r => {
            payload.push([JSON.stringify(r)]);
        });
        
        await fetch(CLOUD_URL, { 
            method: 'POST', 
            mode: 'no-cors', 
            headers: { 'Content-Type': 'text/plain' },
            body: JSON.stringify(payload)
        });
        
        dot.style.background = 'var(--success)';
        console.log("Sync Success: " + records.length + " records saved row-by-row.");
    } catch(e) { 
        console.error("Sync to Cloud failed:", e);
        dot.style.background = 'var(--danger)'; 
    }
}
   async function syncFromCloud() {
    const dot = document.getElementById('sync-dot');
    dot.style.background = 'orange';

    // --- TARGET ONLY THE EMOJI ---
    const icon = document.getElementById('pull-icon');
    if (icon) icon.classList.add('spinning');

    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 15000); 

    try {
        const url = CLOUD_URL + "?t=" + new Date().getTime();
        const response = await fetch(url, {
            method: 'GET',
            signal: controller.signal,
            redirect: 'follow'
        });

        clearTimeout(timeoutId);

        if (!response.ok) throw new Error('Network error');
        const rows = await response.json(); 

        if (rows && rows.length > 0) {
            let cloudRecords = [];
            let cloudInventory = [];

            rows.forEach(row => {
                if (row[0]) {
                    try {
                        const content = JSON.parse(row[0]);
                        if (content.type === 'inventory_header') {
                            cloudInventory = content.inventory || [];
                        } else {
                            cloudRecords.push(content);
                        }
                    } catch(err) {
                        console.error("Skipping corrupted row:", err);
                    }
                }
            });

            await db.records.clear();
            await db.inventory.clear();
            
            if (cloudRecords.length > 0) await db.records.bulkPut(cloudRecords);
            if (cloudInventory.length > 0) await db.inventory.bulkPut(cloudInventory);
            
            dot.style.background = 'var(--success)';
            
            refreshDashboardMetrics();
            refreshReportDisplay();
            const invContainer = document.getElementById('inventory');
            if(invContainer && !invContainer.classList.contains('hidden')) {
                refreshInventoryDisplay('acc');
            }
        }
    } catch (e) {
        dot.style.background = 'var(--danger)';
        console.error("Sync failed:", e);
    } finally {
        // --- STOP ONLY THE EMOJI ---
        if (icon) icon.classList.remove('spinning');
    }
}

    // ENTRY LOGIC
    // ENTRY LOGIC
    function updateEntryUIVisibility() {
        const cat = document.getElementById('sale-cat').value;
        document.getElementById('ui-standard').className = (cat === 'Accessory' || cat === 'Phone') ? '' : 'hidden';
        document.getElementById('ui-repair').className = (cat === 'Repair') ? '' : 'hidden';
        document.getElementById('ui-pawn').className = (cat === 'Pawn') ? '' : 'hidden';
        document.getElementById('ui-expense').className = (cat === 'Expense' || cat === 'ServiceExpense') ? '' : 'hidden';
    }

    async function handleSaleAutoFill() {
        const val = document.getElementById('sale-item-name').value;
        const item = await db.inventory.where('name').equals(val).first();
        if(item) {
            document.getElementById('sale-price').value = item.sell;
            document.getElementById('sale-cat').value = item.type;
            updateEntryUIVisibility();
        }
    } 

 async function processTransaction() {
    const cat = document.getElementById('sale-cat').value;
    const date = document.getElementById('sale-date').value || getFormattedToday();
    let data = { date, cat, status: 'Completed', qty: 1 };

  // --- 1. ACCESSORIES & PHONES ---
    if(cat === 'Accessory' || cat === 'Phone') {
        const name = document.getElementById('sale-item-name').value;
        const stock = await db.inventory.where('name').equals(name).first();
        const qty = parseInt(document.getElementById('sale-qty').value) || 1;
        const price = parseFloat(document.getElementById('sale-price').value) || 0;
        
        data.qty = qty;
        data.item = name;
        data.sell = document.getElementById('sale-per-unit').checked ? (price * qty) : price;
        data.buy = (stock ? stock.buy : 0) * qty;
        data.isStockPart = true; 

        // Subtract the main item from stock
        if(stock) await db.inventory.update(stock.id, { qty: stock.qty - qty });

        // --- NEW: MULTI-GIFT LOGIC (The Bubbles) ---
        if(selectedGifts && selectedGifts.length > 0) {
            for (let giftName of selectedGifts) {
                const promoItem = await db.inventory.where('name').equals(giftName).first();
                if(promoItem) {
                    // Subtract 1 from stock for each gift
                    await db.inventory.update(promoItem.id, { qty: (promoItem.qty || 1) - 1 });
                    
                    // Add the cost of the gift to your expenses
                    data.buy += (promoItem.buy || 0);
                    
                    // Add the name to the record so you see it in reports
                    data.item += " (+ " + giftName + ")";
                }
            }
        }

    // --- 2. REPAIRS ---
    } else if(cat === 'Repair') {
        const partName = document.getElementById('rep-part-name').value; 
        const promoName = document.getElementById('rep-promo-item').value; // Get the Promo/Gift name
        
        data.customer = document.getElementById('rep-customer').value || ""; 
        data.item = "Service: " + (document.getElementById('rep-desc').value || "Unknown Model");
        data.error = document.getElementById('rep-error').value; 
        
        // Base Repair Prices
        data.buy = parseFloat(document.getElementById('rep-cost').value) || 0;
        data.sell = parseFloat(document.getElementById('rep-charge').value) || 0;
        data.partName = partName; 

        // A. MAIN PART STOCK CHECK
        const stockItem = await db.inventory.where('name').equals(partName).first();
        if(partName && stockItem) {
            data.isStockPart = true; 
            await db.inventory.update(stockItem.id, { qty: (stockItem.qty || 1) - 1 });
        } else {
            data.isStockPart = false; 
        }

        // B. PROMO / GIFT LOGIC
        if(promoName) {
            const promoItem = await db.inventory.where('name').equals(promoName).first();
            if(promoItem) {
                // This popup shows your COST and asks what to charge the customer
                const promoCharge = parseFloat(prompt(
                    `PROMO ADDED: ${promoName}\n` +
                    `Your Buy Price (Cost): $${promoItem.buy}\n` +
                    `Enter amount to charge customer (0 for free):`, 
                    promoItem.buy // Default is your cost
                )) || 0;
                
                // Subtract 1 from stock for the gift/promo
                await db.inventory.update(promoItem.id, { qty: (promoItem.qty || 1) - 1 });
                
                // Add the cost of the gift to your expenses
                data.buy += (promoItem.buy || 0);
                // Add your custom price to the customer's total bill
                data.sell += promoCharge;
                
                // Update the item name so it shows in reports
                data.item += " (+ Promo: " + promoName + ")";
            }
        }

    // --- 3. PAWNS ---
    } else if(cat === 'Pawn') {
        data.item = "Pawn: " + (document.getElementById('pawn-info').value || "No Description");
        data.buy = parseFloat(document.getElementById('pawn-loan').value) || 0;
        data.sell = parseFloat(document.getElementById('pawn-interest').value) || 0;
        data.status = 'In Shop';
        data.isStockPart = false;

    // --- 4. EXPENSES ---
    } else {
        data.item = (cat === 'ServiceExpense' ? "SrvTool: " : "Exp: ") + (document.getElementById('exp-name').value || "General Expense");
        data.buy = parseFloat(document.getElementById('exp-amount').value) || 0;
        data.sell = 0;
        data.isStockPart = false;
    }  

    // --- 5. SAVE ---
    if(!data.item || data.item.trim() === "" || data.item.includes("undefined")) {
        alert("Please enter item details/model before processing.");
        return;
    }

    await db.records.add(data);
    if (typeof syncToCloud === "function") syncToCloud();

   // --- 6. CLEAR ALL INPUTS ---
    const idsToClear = [
        'sale-item-name', 'sale-price', 'sale-qty', 'sale-promo-search', 
        'rep-desc', 'rep-error', 'rep-part-name', 'rep-cost', 'rep-charge', 
        'exp-name', 'exp-amount', 'pawn-info', 'pawn-loan', 'pawn-interest',
        'rep-customer', 'rep-promo-item' 
    ];
    
    // First, clear all the standard text boxes
    idsToClear.forEach(id => {
        const el = document.getElementById(id);
        if(el) {
            if(id === 'sale-qty') el.value = '1';
            else el.value = '';
        }
    });

    // Second, clear the special Multi-Gift bubbles and the hidden list
    const giftContainer = document.getElementById('sale-gift-container');
    if(giftContainer) giftContainer.innerHTML = ''; 
    
    selectedGifts = []; // IMPORTANT: This resets the list for the next customer

    // --- 7. REFRESH ---
    changeGlobalTab('dashboard');
    refreshDashboardMetrics();
}

    // INVENTORY LOGIC
    function updateAddStockUIVisibility() {
        const type = document.getElementById('add-main-type').value;
        document.getElementById('add-form-accessory').className = (type === 'Accessory') ? '' : 'hidden';
        document.getElementById('add-form-phone').className = (type === 'Phone') ? '' : 'hidden';
    }

    function handleCustomCategoryToggle() {
        const val = document.getElementById('add-sub-select').value;
        document.getElementById('add-custom-cat-input').className = (val === 'CUSTOM') ? '' : 'hidden';
    }

   async function saveNewStockItem() {
    // 1. COLLECT INPUTS FIRST
    const type = document.getElementById('add-main-type').value;
    let sub = "";
    
    if (type === 'Accessory') {
        sub = document.getElementById('add-sub-select').value;
        if (sub === 'CUSTOM') sub = document.getElementById('add-custom-cat-input').value;
    } else if (type === 'Parts') {
        sub = 'Parts'; 
    } else {
        sub = 'Smartphone'; 
    }

    // 2. CREATE THE ENTRY OBJECT
    const entry = {
        type: type, 
        name: document.getElementById('add-item-name').value,
        buy: parseFloat(document.getElementById('add-buy-price').value) || 0,
        sell: parseFloat(document.getElementById('add-sell-price').value) || 0,
        qty: parseInt(document.getElementById('add-stock-qty').value) || 0,
        sub: sub,
        cond: type === 'Phone' ? document.getElementById('add-phone-condition').value : '',
        specs: type === 'Phone' ? document.getElementById('add-phone-specs').value : ''
    };

    if (!entry.name) return alert("Please enter a name");

    // 3. CHECK IF ITEM EXISTS IN DATABASE
    const existingItem = await db.inventory.where('name').equals(entry.name).first();

    if (existingItem) {
        // UPDATE: Add new quantity to old quantity
        const newQty = existingItem.qty + entry.qty;
        await db.inventory.update(existingItem.id, { 
            qty: newQty, 
            buy: entry.buy, 
            sell: entry.sell 
        });
        alert("Updated quantity for: " + entry.name);
    } else {
        // ADD: Truly new item
        await db.inventory.add(entry);
        alert("Added new item: " + entry.name);
    }

    // 4. TRIGGER LEARNING & SYNC
    await updateLearnedCategories();
    if (typeof syncToCloud === "function") syncToCloud();

    // 5. CLEAR ALL INPUTS
    document.getElementById('add-item-name').value = '';
    document.getElementById('add-buy-price').value = '';
    document.getElementById('add-sell-price').value = '';
    document.getElementById('add-stock-qty').value = '1';
    document.getElementById('add-phone-specs').value = '';
    document.getElementById('add-custom-cat-input').value = '';

    // 6. REFRESH VIEW
    switchInventorySubTab(type === 'Accessory' ? 'acc' : (type === 'Phone' ? 'phone' : 'Parts'));
}
async function updateLearnedCategories() {
    const invItems = await db.inventory.toArray();
    const counts = {};
    
    // 1. Count how many times each sub-category is used
    invItems.forEach(item => {
        if (item.sub && item.type === 'Accessory') {
            counts[item.sub] = (counts[item.sub] || 0) + 1;
        }
    });

    // 2. Your Standard list
    const defaults = ['V8 Cable', 'Type-C Cable', 'Earphone', 'Airpods', 'Charger'];
    const selectBox = document.getElementById('add-sub-select');
    
    // 3. Build the new list for the dropdown
    let optionsHtml = defaults.map(o => `<option value="${o}">${o}</option>`).join('');

    // 4. If a custom name is used 3+ times, add it to the main list
    for (let cat in counts) {
        if (counts[cat] >= 3 && !defaults.includes(cat)) {
            optionsHtml += `<option value="${cat}">${cat}</option>`;
        }
    }

    // 5. Always keep the CUSTOM option at the bottom
    optionsHtml += `<option value="CUSTOM">-- WRITE CUSTOM CATEGORY --</option>`;
    selectBox.innerHTML = optionsHtml;
}

    async function refreshInventoryDisplay(tab = 'acc') {
    const search = document.getElementById('inv-search-box').value.toLowerCase();
    const items = await db.inventory.toArray();
    let html = '';

    if(tab === 'acc') {
        // Filter, then REVERSE so newest is first
        html = items.filter(i => i.type === 'Accessory' && i.name.toLowerCase().includes(search))
                    .reverse() 
                    .map(i => `
            <div class="card">
                <b>${i.name}</b> <small>(${i.sub})</small><br>
                <small>Qty: ${i.qty} | Buy: $${i.buy} | Sell: $${i.sell}</small>
                <div class="control-panel">
                    <button class="btn-edit" onclick="modifyStock(${i.id})">Edit</button>
                    <button class="btn-delete" onclick="deleteStock(${i.id})">Delete</button>
                </div>
            </div>`).join('');
    } else if(tab === 'phone') {
        html = items.filter(i => i.type === 'Phone' && i.name.toLowerCase().includes(search))
                    .reverse()
                    .map(i => `
            <div class="card">
                <b>${i.name}</b> <span class="badge" style="background:#eee">${i.cond}</span><br>
                <small>${i.specs}</small><br>
                <small>Qty: ${i.qty} | Price: $${i.sell}</small>
                <div class="control-panel">
                    <button class="btn-edit" onclick="modifyStock(${i.id})">Edit</button>
                    <button class="btn-delete" onclick="deleteStock(${i.id})">Delete</button>
                </div>
            </div>`).join('');
    } else if(tab === 'Parts') {
        html = items.filter(i => i.type === 'Parts' && i.name.toLowerCase().includes(search))
                    .reverse()
                    .map(i => `
            <div class="card" style="border-left: 4px solid var(--primary-color);">
                <b>${i.name}</b> <span class="badge" style="background:var(--accent-color); color:white">Part</span><br>
                <small>Stock: <b>${i.qty}</b> pieces</small><br>
                <small>Cost: $${i.buy} | Target: $${i.sell}</small>
                <div class="control-panel">
                    <button class="btn-edit" onclick="modifyStock(${i.id})">Edit</button>
                    <button class="btn-delete" onclick="deleteStock(${i.id})">Delete</button>
                </div>
            </div>`).join('');
    } else if(tab === 'pawn') {
        const pawns = await db.records.where('cat').equals('Pawn').toArray();
        
        // REVERSE Pawns so the newest one added is at the top of the list
        html = pawns.reverse().map(p => `
            <div class="card">
                <b>${p.item}</b> <span class="badge" style="float:right; background:${p.status === 'In Shop' ? 'var(--warning)' : 'var(--success)'}; color:white">${p.status}</span><br>
                <small>Date: ${p.date} | Loan: $${p.buy} | Int: $${p.sell}</small>
                <div class="control-panel">
                    <button class="btn-edit" onclick="togglePawn(${p.id},'${p.status}')">Toggle Status</button>
                    <button class="btn-delete" onclick="deleteRec(${p.id})">Delete</button>
                </div>
            </div>`).join('');
    }
    document.getElementById('inv-render-target').innerHTML = html;
}
    async function togglePawn(id, s) {
    // 1. Determine the new status
    const newStatus = (s === 'In Shop' ? 'Collected' : 'In Shop');
    
    // 2. Prepare the update data
    let updateData = { status: newStatus };

    // 3. If we are moving it to 'Collected', also move the date to TODAY
    if (newStatus === 'Collected') {
        const today = new Date().toISOString().split('T')[0];
        updateData.date = today;
    }

    // 4. Update the database
    await db.records.update(id, updateData);

    // 5. Success message
    if (newStatus === 'Collected') {
        alert("Pawn marked as Collected! Profit moved to today's date.");
    }

    // 6. Refresh the UI
    refreshInventoryDisplay('pawn');
    refreshDashboardMetrics(); // Ensure the dashboard profit updates immediately
    if (typeof syncToCloud === 'function') syncToCloud();
}

    // DASHBOARD & REPORT REFRESH
 async function refreshDashboardMetrics() {
    let from = document.getElementById('dash-from').value;
    let to = document.getElementById('dash-to').value;
    const todayStr = new Date().toISOString().split('T')[0];
    
    let overviewFrom = from || "2020-01-01"; 
    let overviewTo = to || "2030-12-31";
    
    let allRecs = await db.records.toArray();
    const inv = await db.inventory.toArray();
    
    let filteredRecs = allRecs.filter(r => r.date >= overviewFrom && r.date <= overviewTo);

    let todaySales = 0;
    let todayProfit = 0;
    allRecs.filter(r => r.date === todayStr).forEach(r => {
        if(r.cat === 'Expense' || r.cat === 'ServiceExpense') {
            todayProfit -= (r.buy || 0);
        } else if (r.cat === 'Repair') {
            todaySales += (r.sell || 0);
            todayProfit += ((r.sell || 0) - (r.buy || 0));
        } else if (r.cat === 'Pawn') {
            if(r.status === 'Collected') {
                todaySales += (r.sell || 0);
                todayProfit += (r.sell || 0);
            }
        } else {
            todaySales += (r.sell || 0);
            todayProfit += ((r.sell || 0) - (r.buy || 0));
        }
    });

    let totalRevenue = 0;
    let serviceExpense = 0;
    let generalExpense = 0;
    let costOfGoodsSold_Filtered = 0;
    let oldStockValueUsed = 0;

    // --- ADD THIS VARIABLE HERE ---
    let totalServiceRepairProfit = 0; 

    filteredRecs.forEach(r => {
        if(r.cat === 'Expense') {
            generalExpense += (r.buy || 0); 
        } else if (r.cat === 'ServiceExpense') {
            serviceExpense += (r.buy || 0);
        } else if (r.cat === 'Repair') {
            // --- ADD THIS LINE: Calculate profit for each repair ---
            totalServiceRepairProfit += ((r.sell || 0) - (r.buy || 0));

            serviceExpense += (r.buy || 0); 
            totalRevenue += (r.sell || 0);
            if(r.isStockPart === true) {
                oldStockValueUsed += (r.buy || 0);
            }
        } else if (r.cat === 'Pawn') {
            if(r.status === 'Collected') {
                totalRevenue += (r.sell || 0);
            }
        } else {
            totalRevenue += (r.sell || 0);
            costOfGoodsSold_Filtered += (r.buy || 0);
            oldStockValueUsed += (r.buy || 0);
        }
    });

    let currentInventoryValue = 0;
    inv.forEach(i => {
        currentInventoryValue += (i.buy * (parseInt(i.qty) || 0));
    });

    let totalCostOfAllSoldItems = 0;
    allRecs.forEach(r => {
        if(r.cat === 'Accessory' || r.cat === 'Phone') {
            totalCostOfAllSoldItems += (r.buy || 0);
        }
    });

    let totalStockInvested = currentInventoryValue + totalCostOfAllSoldItems;

    let netProfit = totalRevenue - costOfGoodsSold_Filtered - serviceExpense;
    let cashInHand = netProfit - generalExpense + oldStockValueUsed; 

    // UPDATE UI
    document.getElementById('dash-sales').innerText = `$${todaySales.toFixed(2)}`;
    document.getElementById('dash-profit').innerText = `$${todayProfit.toFixed(2)}`;
    document.getElementById('dash-cash').innerText = `$${cashInHand.toFixed(2)}`;
    document.getElementById('fin-total-invest').innerText = `$${totalStockInvested.toFixed(2)}`;
    document.getElementById('fin-invest').innerText = `$${currentInventoryValue.toFixed(2)}`;
    document.getElementById('fin-serv-exp').innerText = `$${serviceExpense.toFixed(2)}`;
    document.getElementById('fin-gen-exp').innerText = `$${generalExpense.toFixed(2)}`;
    document.getElementById('fin-earn').innerText = `$${totalRevenue.toFixed(2)}`;
    document.getElementById('fin-net').innerText = `$${netProfit.toFixed(2)}`;

    // --- ADD THIS LINE: Display the result ---
    const servProfEl = document.getElementById('fin-service-profit');
    if(servProfEl) servProfEl.innerText = `$${totalServiceRepairProfit.toFixed(2)}`;
}

    function toggleReportMode() {
        reportViewMode = (reportViewMode === 'daily') ? 'range' : 'daily';
        document.getElementById('pager-daily').className = (reportViewMode === 'daily') ? 'pager-controls' : 'hidden';
        document.getElementById('pager-range').className = (reportViewMode === 'range') ? 'range-controls' : 'hidden';
        document.getElementById('pager-mode-title').innerText = (reportViewMode === 'daily') ? 'DAILY VIEW' : 'RANGE VIEW';
        refreshReportDisplay();
    }

    function changeReportDate(days) {
    const input = document.getElementById('report-date-input');
    const d = new Date(input.value);
    
    // Calculate the new date
    d.setDate(d.getDate() + days);
    const newDateStr = d.toISOString().split('T')[0];
    
    // Get Today's date
    const todayStr = new Date().toISOString().split('T')[0];

    // THE LOCK: Only update if the new date is NOT greater than today
    if (newDateStr <= todayStr) {
        input.value = newDateStr;
        refreshReportDisplay();
    } else {
        // Optional: you can show a small alert or just do nothing
        console.log("Cannot go beyond today");
    }
}

    function setReportFilter(f) {
    currentReportFilter = f;
    
    // 1. Clear shade from all buttons (Your original line)
    document.querySelectorAll('#records .sub-nav button').forEach(b => b.classList.remove('active'));
    
    // 2. Add this line to put the shade on the clicked button
    // It finds the button that was clicked and adds 'active' back to it
    event.currentTarget.classList.add('active');

    refreshReportDisplay();
}
  // Add (manualDate = null) here so the function knows what 'manualDate' is
async function refreshReportDisplay(manualDate = null) {
    const dateInput = document.getElementById('report-date-input');
    
    // 1. Determine which date to use
    // Use manualDate if we passed one (like from the Back button), 
    // otherwise use the box value, otherwise today.
    const targetDate = manualDate || dateInput.value || getFormattedToday();
    
    // Update the input box so the calendar shows the date we are actually viewing
    dateInput.value = targetDate;

    let raw = await db.records.toArray();
    
    // 2. Filter by Date (Respecting the view mode)
    if(reportViewMode === 'daily') {
        raw = raw.filter(r => r.date === targetDate);
    } else {
        const f = document.getElementById('rep-from').value;
        const t = document.getElementById('rep-to').value;
        if(f && t) raw = raw.filter(r => r.date >= f && r.date <= t);
    }

    // 3. Filter by Category
    if(currentReportFilter !== 'All') raw = raw.filter(r => r.cat === currentReportFilter);

    let rev = 0, prof = 0;
    const groupedData = {};

    // 4. Calculate Totals AND Group Items
    raw.forEach(r => {
        const isValid = (r.cat !== 'Pawn' || r.status === 'Collected');
        
        if(isValid) { 
            if (r.cat === 'Expense' || r.cat === 'ServiceExpense') {
                prof -= (r.buy || 0); 
            } else if (r.cat === 'Pawn') {
                rev += (r.sell || 0); 
                prof += (r.sell || 0); 
            } else {
                rev += (r.sell || 0); 
                prof += ((r.sell || 0) - (r.buy || 0)); 
            }

            // Include customer in the key so different customers show as different rows
            const key = r.item + "||" + r.cat + "||" + (r.error || "") + "||" + (r.customer || ""); 
            
            if (!groupedData[key]) {
                let initialVal;
                if (r.cat === 'Pawn') {
                    initialVal = (r.sell || 0); 
                } else {
                    initialVal = (r.cat === 'Expense' || r.cat === 'ServiceExpense') ? (r.buy || 0) : (r.sell || 0);
                }
                
                groupedData[key] = { ...r, count: 1, displayPrice: initialVal }; 
            } else {
                groupedData[key].qty += (r.qty || 0);
                groupedData[key].count += 1;
                
                if (r.cat === 'Expense' || r.cat === 'ServiceExpense') {
                    groupedData[key].displayPrice += (r.buy || 0);
                } else {
                    groupedData[key].displayPrice += (r.sell || 0);
                }
            }
        }
    });

    document.getElementById('report-financial-summary').innerHTML = `
        <div style="display:flex; justify-content:space-between; font-size:16px; padding:10px;">
            <span>Revenue: $${rev.toFixed(2)}</span>
            <span>Profit: <b style="color:var(--success)">$${prof.toFixed(2)}</b></span>
        </div>
    `;

    // 5. Render Grouped Cards
    document.getElementById('report-items-list').innerHTML = Object.values(groupedData).reverse().map(r => {
        const isExp = (r.cat === 'Expense' || r.cat === 'ServiceExpense');
        
        let secondaryText = '';
        if (r.cat === 'Repair') {
            const cust = r.customer ? `<span style="color:var(--primary); font-weight:bold;">[${r.customer}]</span> ` : '';
            const modelClean = r.item.replace("Service: ", "");
            const prob = r.error ? `<br>‚ö† Problem: ${r.error}` : '';
            
            secondaryText = `<div style="color: var(--warning); font-size: 12px; margin-top: 2px; font-style: italic;">
                                ${cust} <b>${modelClean}</b> ${prob}
                             </div>`;
        } else if (r.cat === 'Pawn') {
            secondaryText = `<div style="color: var(--primary); font-size: 11px; margin-top: 2px;">Status: ${r.status} (Interest Only)</div>`;
        }

        return `
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <b>${r.item}</b> <span style="color:var(--warning)">(${r.count})</span><br>
                    ${secondaryText} <small>Total Qty: ${r.qty} | ${r.cat}</small>
                </div>
                <div style="text-align:right">
                    <b style="${isExp ? 'color:var(--danger)' : ''}">
                        ${isExp ? '-' : ''}$${r.displayPrice.toFixed(2)}
                    </b><br>
                    <button onclick="showDetails('${r.item.replace(/'/g, "\\'")}', '${r.cat}')" 
                            style="margin-top:5px; background:var(--primary); border:none; color:white; padding:5px 10px; border-radius:5px; font-size:11px;">
                        View Details
                    </button>
                </div>
            </div>
        </div>`;
    }).join('');
}
    async function deleteRec(id) {
    if(confirm("Delete this record permanently?")) { 
        // 1. GET THE RECORD DATA BEFORE DELETING
        const record = await db.records.get(id);
        
        if (record) {
            // 2. CHECK IF IT WAS AN ACCESSORY, PHONE, OR A REPAIR USING STOCK
            if (record.cat === 'Accessory' || record.cat === 'Phone' || (record.cat === 'Repair' && record.isStockPart === true)) {
                
                // Determine which name to search for in inventory
                // For Accessories, it's 'item'. For Repairs, it's 'partName'.
                const nameToFind = record.partName || record.item;

                // 3. FIND THE ITEM IN INVENTORY
                const inventoryItem = await db.inventory.where('name').equals(nameToFind).first();
                
                if (inventoryItem) {
                    // 4. REFILL THE STOCK
                    // If qty is missing in record (like in Repairs), we assume 1
                    const amountToRestore = record.qty || 1;
                    const newQty = (inventoryItem.qty || 0) + amountToRestore;
                    
                    await db.inventory.update(inventoryItem.id, { qty: newQty });
                    console.log(`Restored ${amountToRestore} to ${nameToFind}`);
                }
            }
        }

        // 5. DELETE AND REFRESH
        await db.records.delete(id); 
        refreshReportDisplay(); 
        refreshDashboardMetrics();
        syncToCloud();
    }
}
function closeDetailsView() {
    // 1. Hide the detailed view
    document.getElementById('detailed-view').classList.add('hidden');
    
    // 2. Show the records (Report) section
    document.getElementById('records').classList.remove('hidden');
    
    // 3. Get the date currently in the report calendar
    const selectedDate = document.getElementById('report-date-input').value;
    
    // 4. Refresh the report for THAT date (not today)
    refreshReportDisplay(selectedDate);
}
async function deleteStock(id) {
    if(confirm("Delete this item from inventory?")) {
        await db.inventory.delete(id);
        refreshInventoryDisplay();
        syncToCloud();
    }
}

async function modifyStock(id) {
    const item = await db.inventory.get(id);
    const newQty = prompt("Edit Quantity:", item.qty);
    const newSell = prompt("Edit Selling Price:", item.sell);
    const newBuy = prompt("Edit Buy Price (Cost):", item.buy);

    if (newQty !== null && newSell !== null && newBuy !== null) {
        await db.inventory.update(id, {
            qty: parseInt(newQty) || 0,
            sell: parseFloat(newSell) || 0,
            buy: parseFloat(newBuy) || 0
        });
        refreshInventoryDisplay();
        syncToCloud();
    }
}
    async function changeGlobalTab(tabID) {
    // THIS LINE JUMPS THE PAGE TO THE TOP IMMEDIATELY WHEN TAB CHANGES
    window.scrollTo(0, 0);

    document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
    document.getElementById(tabID).classList.remove('hidden');
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    
    const navMap = {dashboard:'das', 'sales-entry':'sal', inventory:'inv', records:'rec'};
    document.getElementById('btn-' + navMap[tabID]).classList.add('active');

    if(tabID === 'dashboard') refreshDashboardMetrics();
    
    if(tabID === 'records') {
        document.getElementById('report-date-input').value = getFormattedToday();
        document.getElementById('rep-from').value = getFormattedToday();
        document.getElementById('rep-to').value = getFormattedToday();
        refreshReportDisplay();
    }
    
    if(tabID === 'sales-entry') {
        document.getElementById('sale-date').value = getFormattedToday();
        const invItems = await db.inventory.toArray();

        // 1. FILL STANDARD STOCK (Excludes anything labeled 'Parts')
        document.getElementById('stock-datalist').innerHTML = invItems
            .filter(i => i.sub !== 'Parts' && i.type !== 'Parts') 
            .map(i => `<option value="${i.name}">`).join('');

        // 2. FILL REPAIR PARTS (Only shows items where sub-type or type is 'Parts')
        // Make sure 'parts-datalist' exists in your HTML repair section
        const partsList = document.getElementById('parts-datalist');
        if(partsList) {
            partsList.innerHTML = invItems
                .filter(i => i.sub === 'Parts' || i.type === 'Parts') 
                .map(i => `<option value="${i.name}">`).join('');
        }
    }

    if(tabID === 'inventory') {
        switchInventorySubTab('acc');
    }
}
async function refreshStockNameSuggestions() {
    try {
        const items = await db.inventory.toArray();
        const dataList = document.getElementById('all-stock-names');
        if (dataList) {
            // This fills the list with all your current product names
            dataList.innerHTML = items.map(i => `<option value="${i.name}">`).join('');
        }
    } catch (err) {
        console.error("Error loading suggestions:", err);
    }
}
 async function switchInventorySubTab(tab) {
    // 1. Handle Button Active States
    document.querySelectorAll('#inventory .sub-nav button').forEach(b => b.classList.remove('active'));
    const btn = document.getElementById('inv-tab-' + tab);
    if(btn) btn.classList.add('active');

    // 2. Toggle between the List view and the Add Item form
    if(tab === 'add') {
        document.getElementById('inv-list-container').classList.add('hidden');
        document.getElementById('inv-add-container').classList.remove('hidden');
        
        // --- THIS UPDATES THE SEARCH LIST FOR THE CUSTOM BOX ---
        refreshStockNameSuggestions(); 
    } else {
        document.getElementById('inv-list-container').classList.remove('hidden');
        document.getElementById('inv-add-container').classList.add('hidden');
        
        // Refresh the display for the selected category (acc, phone, Parts)
        refreshInventoryDisplay(tab); 
    }
}

async function showDetails(itemName, category) {
    document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
    document.getElementById('detailed-view').classList.remove('hidden');
    
    document.getElementById('detail-title').innerText = itemName + " History";

    let raw = await db.records.toArray();
    const d = document.getElementById('report-date-input').value;
    
    // --- UPDATED FILTER: Now also filters by the error to match the card you clicked ---
    // This ensures you only see details for the specific "Problem" you selected
    let filtered = raw.filter(r => {
        const dateMatch = r.date === d;
        const itemMatch = r.item === itemName;
        const catMatch = r.cat === category;
        return dateMatch && itemMatch && catMatch;
    });

    // 1. Add Header with Select All and Bulk Delete Button
    let html = `
        <div style="display:flex; justify-content:space-between; align-items:center; background:rgba(255,255,255,0.05); padding:12px; border-radius:12px; margin-bottom:15px; border:1px dashed #555;">
            <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                <input type="checkbox" id="select-all-cb" style="transform:scale(1.2)" onclick="toggleAllDetails(this)"> 
                <span style="font-weight:bold;">Select All</span>
            </label>
            <button id="bulk-delete-btn" class="btn-delete" style="display:none; padding:6px 15px; margin:0;" onclick="deleteSelectedDetails()">
                Delete Selected (0)
            </button>
        </div>
        <div id="cards-container">
    `;

    // 2. Individual Cards with Checkboxes
    html += filtered.reverse().map(r => {
        // --- NEW: Generate Error Text for the Detail Card ---
        const errorLine = (r.cat === 'Repair' && r.error) 
            ? `<div style="color:var(--warning); font-size:12px; margin-bottom:4px;">‚ö† ${r.error}</div>` 
            : '';

        return `
        <div class="card" style="border-left: 4px solid var(--success); display:flex; align-items:center; gap:15px;">
            <input type="checkbox" class="row-checkbox" value="${r.id}" style="transform:scale(1.2)" onclick="updateBulkBtn()">
            <div style="flex-grow:1;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        ${errorLine} <strong>Qty: ${r.qty}</strong><br>
                        <small>Price: $${r.sell.toFixed(2)}</small>
                    </div>
                    <button class="btn-delete" style="padding:4px 10px; font-size:11px;" onclick="confirmDeleteDetail(${r.id})">Delete</button>
                </div>
            </div>
        </div>`;
    }).join('');

    document.getElementById('detail-list').innerHTML = html + `</div>`;
}
// Function to check/uncheck all boxes
function toggleAllDetails(master) {
    const checkboxes = document.querySelectorAll('.row-checkbox');
    checkboxes.forEach(cb => cb.checked = master.checked);
    updateBulkBtn();
}

// Function to show/hide the big delete button and update the count
function updateBulkBtn() {
    const selected = document.querySelectorAll('.row-checkbox:checked');
    const btn = document.getElementById('bulk-delete-btn');
    if (selected.length > 0) {
        btn.style.display = 'block';
        btn.innerText = `Delete Selected (${selected.length})`;
    } else {
        btn.style.display = 'none';
        document.getElementById('select-all-cb').checked = false;
    }
}

// Function to delete multiple items at once
async function deleteSelectedDetails() {
    const selectedCbs = document.querySelectorAll('.row-checkbox:checked');
    const idsToDelete = Array.from(selectedCbs).map(cb => parseInt(cb.value));

    if (confirm(`Delete ${idsToDelete.length} selected records? Stock will be restored for each.`)) {
        // We use a loop to call your existing deleteRec so stock is updated correctly for each item
        for (let id of idsToDelete) {
            await deleteRec(id);
        }
        
        // Go back to the main report and refresh everything
        changeGlobalTab('records');
        if(typeof refreshReportDisplay === "function") refreshReportDisplay();
        alert("Selected records deleted successfully.");
    }
}
async function autoFillRepairPart() {
    const partName = document.getElementById('rep-part-name').value;
    
    if (partName) {
        // Look up the part in your Inventory database
        const item = await db.inventory.where('name').equals(partName).first();
        
        if (item) {
            // Put the buy price from inventory into the Part Cost box
            document.getElementById('rep-cost').value = item.buy || 0;
            console.log("Price auto-filled from stock: ", item.buy);
        } else {
            // If it's a new part not in stock, leave cost at 0 or empty for you to type
            document.getElementById('rep-cost').value = '';
        }
    } 
} 

async function confirmDeleteDetail(id) {
    if(confirm("Are you sure you want to delete this specific sale?")) {
        await deleteRec(id); // Use your existing deleteRec to fix stock
        changeGlobalTab('records'); // Go back to main report
        refreshReportDisplay(); // Refresh the list
    }
}
// Special delete function to refresh views properly
async function deleteAndGoBack(id) {
    if(confirm("Delete this specific sale?")) {
        await deleteRec(id); // This is your existing delete function that fixes stock
        changeGlobalTab('records'); // Go back to the main report
    }
}
  async function generatePDF() {
    try {
        // 1. Grab every single piece of data
        const allRecs = await db.records.toArray();
        const allInv = await db.inventory.toArray();
        const timestamp = new Date().toLocaleString();

        let totalProfit = 0; // Variable to track total earnings

        // --- 2. CREATE THE HUMAN READABLE REPORT (TXT) ---
        let report = `==========================================\n`;
        report += `   ELITE SHOP MANAGER - FULL DATABASE    \n`;
        report += `   Generated: ${timestamp}               \n`;
        report += `==========================================\n\n`;

        // SECTION 1: STOCK / INVENTORY
        report += `[ SECTION 1: CURRENT STOCK ON SHELVES ]\n`;
        report += `------------------------------------------------------------\n`;
        report += `${"ITEM NAME".padEnd(25)} | ${"QTY".padEnd(5)} | ${"BUY".padEnd(8)} | ${"SELL"}\n`;
        report += `------------------------------------------------------------\n`;
        
        allInv.forEach(i => {
            const name = (i.name || "Unknown Item").substring(0, 24);
            const qty = String(i.qty || 0);
            const buy = String(i.buy || 0);
            const sell = String(i.sell || 0);
            report += `${name.padEnd(25)} | ${qty.padEnd(5)} | $${buy.padEnd(7)} | $${sell}\n`;
        });

        // SECTION 2: SALES & TRANSACTIONS
        report += `\n\n[ SECTION 2: ALL SALES & TRANSACTION HISTORY ]\n`;
        report += `------------------------------------------------------------\n`;
        report += `${"DATE".padEnd(12)} | ${"CATEGORY".padEnd(10)} | ${"ITEM & CUSTOMER DETAILS".padEnd(30)} | ${"PROFIT"}\n`;
        report += `------------------------------------------------------------\n`;

        allRecs
        .filter(r => r.item && r.item.trim() !== "") 
        .sort((a,b) => new Date(b.date || 0) - new Date(a.date || 0))
        .forEach(r => {
            const rDate = (r.date || "N/A").padEnd(12);
            const rCat = (r.cat || "Other").padEnd(10);
            
            let details = r.item || "No Name";
            let rowProfit = 0;

            // --- REPAIR LOGIC: Add Customer + Model + Error ---
            if(r.cat === 'Repair') {
                const cust = r.customer ? `${r.customer}: ` : '';
                const err = r.error ? ` (${r.error})` : '';
                details = cust + details + err; 
                rowProfit = (parseFloat(r.sell) || 0) - (parseFloat(r.buy) || 0);
            } 
            // --- PAWN LOGIC: Profit is interest ONLY if Collected ---
            else if(r.cat === 'Pawn') {
                if(r.status === 'Collected') {
                    rowProfit = (parseFloat(r.sell) || 0); // Interest only
                    details = `[COLLECTED] ${details}`;
                } else {
                    rowProfit = 0; // Not earned yet
                    details = `[IN SHOP] ${details}`;
                }
            }
            // --- OTHERS (Sales/Expenses) ---
            else if (r.cat === 'Expense' || r.cat === 'ServiceExpense') {
                rowProfit = -(parseFloat(r.buy) || 0);
            }
            else {
                rowProfit = (parseFloat(r.sell) || 0) - (parseFloat(r.buy) || 0);
            }
            
            totalProfit += rowProfit; 
            const rDetails = details.substring(0, 29).padEnd(30);
            
            report += `${rDate} | ${rCat} | ${rDetails} | $${rowProfit.toFixed(2)}\n`;
        });

        // --- 3. SUMMARY SECTION ---
        report += `\n------------------------------------------------------------\n`;
        report += `TOTAL NET PROFIT: $${totalProfit.toFixed(2)}\n`;
        report += `------------------------------------------------------------\n`;
        report += `\n=== END OF REPORT ===`;

        // --- 4. DOWNLOADS ---
        const fName = typeof getFormattedToday === 'function' ? getFormattedToday() : new Date().toISOString().split('T')[0];
        
        // TXT Download
        const txtBlob = new Blob([report], { type: 'text/plain' });
        const txtLink = document.createElement('a');
        txtLink.href = URL.createObjectURL(txtBlob);
        txtLink.download = `Full_Shop_Report_${fName}.txt`;
        txtLink.click();

        // JSON Download (System Restore File)
        const backupData = JSON.stringify({ inventory: allInv, records: allRecs, version: "11.0" }, null, 2);
        const jsonBlob = new Blob([backupData], { type: 'application/json' });
        const jsonLink = document.createElement('a');
        jsonLink.href = URL.createObjectURL(jsonBlob);
        jsonLink.download = `SYSTEM_RESTORE_FILE_${fName}.json`;
        jsonLink.click();

        alert("Done! Report includes Customer Names and Corrected Pawn Profit.");

    } catch (err) {
        console.error(err);
        alert("Export Error: " + err.message);
    }
}
function togglePrivacy() {
    const targets = document.querySelectorAll('.privacy-target');
    const icon = document.getElementById('privacy-icon');
    
    // Toggle the class on all targets
    targets.forEach(el => {
        el.classList.toggle('privacy-hidden');
    });

    // Check if it is currently hidden
    const isHidden = targets[0].classList.contains('privacy-hidden');

    // Save the choice to the browser's memory
    localStorage.setItem('shop_privacy_mode', isHidden ? 'on' : 'off');

    // Update the icon
    icon.innerText = isHidden ? 'üôà' : 'üëÅÔ∏è';
}

    changeGlobalTab('dashboard');
	// This prevents picking future dates from the calendar popup
document.getElementById('report-date-input').setAttribute('max', new Date().toISOString().split('T')[0]);
// Automatically pull data from Google Sheets whenever the app starts
window.addEventListener('load', () => {
const savedPrivacy = localStorage.getItem('shop_privacy_mode');
    if (savedPrivacy === 'on') {
        const targets = document.querySelectorAll('.privacy-target');
        const icon = document.getElementById('privacy-icon');
        targets.forEach(el => el.classList.add('privacy-hidden'));
        if(icon) icon.innerText = 'üôà';
    }
// Run this so your dropdown updates when the app starts
updateLearnedCategories();
    // Small delay to ensure Dexie DB is ready
    setTimeout(() => {
        syncFromCloud();
    }, 1000);
	
});
</script>
</body>
</html>
