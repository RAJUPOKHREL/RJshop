<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Elite Shop Manager Pro - V7.6</title>
    
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        :root { 
            --primary: #2563eb; 
            --bg: #f8fafc; 
            --card: #ffffff; 
            --success: #10b981; 
            --danger: #ef4444; 
            --warning: #f59e0b; 
            --syncing: #3b82f6; 
            --dark: #1e293b;
            --text-main: #1e293b;
            --text-sub: #64748b;
        }

        body { 
            font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            margin: 0; background: var(--bg); padding-bottom: 110px; color: var(--text-main);
            -webkit-tap-highlight-color: transparent;
        }

        /* HEADER & SYNC DOT */
        .header { 
            padding: 15px 20px; background: #ffffff; border-bottom: 1px solid #e2e8f0; 
            display: flex; justify-content: space-between; align-items: center; 
            position: sticky; top: 0; z-index: 1000;
        }

        .sync-btn { 
            background: var(--dark); color: white; border: none; padding: 10px 18px; 
            border-radius: 12px; font-size: 11px; font-weight: 900; cursor: pointer; text-transform: uppercase;
        }

        .status-dot { 
            width: 16px; height: 16px; border-radius: 50%; 
            background: var(--success); 
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            transition: all 0.4s ease;
        }

        .container { padding: 15px; max-width: 600px; margin: auto; }
        
        /* DASHBOARD CARDS */
        .card { 
            background: var(--card); padding: 22px; border-radius: 22px; margin-bottom: 18px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.04); border: 1px solid #f1f5f9; position: relative;
        }

        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .mini-stat { padding: 22px; border-radius: 22px; color: white; }
        .mini-stat small { font-size: 11px; text-transform: uppercase; font-weight: 800; opacity: 0.85; }
        .mini-stat strong { font-size: 26px; display: block; margin-top: 8px; font-weight: 900; }

        label { display: block; font-size: 11px; font-weight: 900; color: var(--text-sub); margin: 15px 0 8px; text-transform: uppercase; letter-spacing: 0.8px; }
        
        input, select { 
            width: 100%; padding: 16px; margin-bottom: 12px; border: 2px solid #f1f5f9; 
            border-radius: 16px; font-size: 16px; box-sizing: border-box; background: #fcfcfd; 
        }

        .action-btn { 
            background: var(--primary); color: white; border: none; width: 100%; padding: 20px; 
            border-radius: 18px; font-weight: 900; cursor: pointer; font-size: 16px; margin-top: 15px;
            box-shadow: 0 6px 15px rgba(37, 99, 235, 0.25);
        }

        /* NAVIGATION */
        .sub-nav { display: flex; gap: 10px; margin-bottom: 20px; background: #e2e8f0; padding: 8px; border-radius: 18px; overflow-x: auto; }
        .sub-nav button { flex: 1; border: none; padding: 14px; border-radius: 12px; font-weight: 800; font-size: 12px; cursor: pointer; background: none; color: #64748b; white-space: nowrap; }
        .sub-nav button.active { background: white; color: var(--primary); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }

        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 100px; background: white; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #e2e8f0; z-index: 1000; }
        .nav-item { border: none; background: none; color: #94a3b8; font-size: 12px; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 8px; flex: 1; }
        .nav-item span { font-size: 32px; }
        .nav-item.active { color: var(--primary); font-weight: 900; }

        .hidden { display: none !important; }
        .badge { padding: 6px 10px; border-radius: 8px; font-size: 11px; font-weight: 900; text-transform: uppercase; }
        
        /* CRUD BUTTONS */
        .control-panel { display: flex; gap: 12px; margin-top: 15px; border-top: 1.5px solid #f1f5f9; padding-top: 15px; }
        .btn-edit { flex: 1; background: #eff6ff; color: var(--primary); border: none; padding: 10px; border-radius: 10px; font-weight: 800; font-size: 12px; cursor: pointer; }
        .btn-delete { flex: 1; background: #fef2f2; color: var(--danger); border: none; padding: 10px; border-radius: 10px; font-weight: 800; font-size: 12px; cursor: pointer; }
    </style>
</head>
<body>

<div class="header">
    <h1 style="font-size: 22px; margin:0; font-weight: 950; letter-spacing: -1.2px;">ELITE SHOP PRO</h1>
    <div style="display:flex; align-items:center; gap:15px;">
        <button class="sync-btn" onclick="syncFromCloud()">üîÑ CLOUD PULL</button>
        <div class="status-dot" id="sync-dot"></div>
    </div>
</div>

<div class="container">
    
    <section id="dashboard">
        <div class="stat-grid">
            <div class="mini-stat" style="background: var(--primary);"><small>Today's Sales</small><strong id="dash-sales">$0.00</strong></div>
            <div class="mini-stat" style="background: var(--success);"><small>Today's Profit</small><strong id="dash-profit">$0.00</strong></div>
        </div>
        <div class="card" style="background: var(--dark); color: white;">
            <h3 style="margin: 0 0 18px 0; color: var(--warning); font-size: 14px; text-transform: uppercase;">Financial Overview</h3>
            <div style="display:flex; justify-content:space-between; margin-bottom:12px;"><span>Inventory Value:</span> <span id="fin-invest">$0.00</span></div>
            <div style="display:flex; justify-content:space-between; margin-bottom:12px;"><span>Total Revenue:</span> <span id="fin-earn" style="color:var(--success)">$0.00</span></div>
            <hr style="opacity:0.15; margin: 18px 0;">
            <div style="display:flex; justify-content:space-between; align-items: center;"><span>NET PROFIT:</span> <span id="fin-net" style="font-weight:950; font-size:28px; color:var(--success)">$0.00</span></div>
        </div>
        <button class="action-btn" style="background: white; color: var(--dark); border: 2px solid #e2e8f0;" onclick="generatePDF()">üì• EXPORT PDF REPORT</button>
    </section>

    <section id="sales-entry" class="hidden">
        <div class="card">
            <label>Date</label><input type="date" id="sale-date">
            <label>Category</label>
            <select id="sale-cat" onchange="updateUI()">
                <option value="Accessory">Product Sale</option>
                <option value="Phone">Phone Sale</option>
                <option value="Repair">Repair</option>
                <option value="Pawn">Pawn</option>
                <option value="Expense">Expense</option>
            </select>
            <div id="ui-standard">
                <label>Item Name</label><input list="stock-datalist" id="sale-item-name" onchange="autoFill()" placeholder="Search...">
                <datalist id="stock-datalist"></datalist>
                <div style="display:flex; gap:12px;">
                    <div style="flex:1;"><label>Qty</label><input type="number" id="sale-qty" value="1"></div>
                    <div style="flex:2;"><label>Price</label><input type="number" id="sale-price"></div>
                </div>
            </div>
            <div id="ui-repair" class="hidden">
                <label>Repair Info</label><input type="text" id="rep-desc" placeholder="Model & Issue">
                <div style="display:flex; gap:12px;"><input type="number" id="rep-cost" placeholder="Part Cost"><input type="number" id="rep-charge" placeholder="Service Fee"></div>
            </div>
            <div id="ui-pawn" class="hidden">
                <label>Pawn Info</label><input type="text" id="pawn-info" placeholder="Name - Model">
                <div style="display:flex; gap:12px;"><input type="number" id="pawn-loan" placeholder="Loan Amount"><input type="number" id="pawn-interest" placeholder="Interest Fee"></div>
            </div>
            <div id="ui-expense" class="hidden">
                <label>Reason</label><input type="text" id="exp-name"><label>Amount</label><input type="number" id="exp-amount">
            </div>
            <button class="action-btn" onclick="saveSale()">SAVE TRANSACTION</button>
        </div>
    </section>

    <section id="inventory" class="hidden">
        <div class="sub-nav">
            <button id="inv-tab-acc" class="active" onclick="switchInv('acc')">STOCKS</button>
            <button id="inv-tab-phone" onclick="switchInv('phone')">PHONES</button>
            <button id="inv-tab-pawn" onclick="switchInv('pawn')">PAWNS</button>
            <button id="inv-tab-add" onclick="switchInv('add')">+ NEW</button>
        </div>
        <div id="inv-list-container">
            <input type="text" id="inv-search" placeholder="Search..." onkeyup="renderInv()">
            <div id="inv-render"></div>
        </div>
        <div id="inv-add-container" class="hidden">
            <div class="card">
                <label>Type</label><select id="add-type" onchange="updateAddUI()"><option value="Accessory">Accessory</option><option value="Phone">Phone</option></select>
                <div id="add-acc-fields">
                    <label>Sub-Type</label><select id="add-sub" onchange="checkCustom()"><option>V8 Cable</option><option>Type-C</option><option>Earphone</option><option>Airpods</option><option value="CUSTOM">-- CUSTOM --</option></select>
                    <input type="text" id="add-custom" class="hidden" placeholder="Enter Category">
                </div>
                <div id="add-phone-fields" class="hidden">
                    <label>Condition</label><select id="add-cond"><option>Brand New</option><option>Second Hand</option></select>
                    <label>Specs (RAM/ROM)</label><input type="text" id="add-specs">
                </div>
                <label>Product Name</label><input type="text" id="add-name">
                <div style="display:flex; gap:12px;"><div><label>Buy</label><input type="number" id="add-buy"></div><div><label>Sell</label><input type="number" id="add-sell"></div></div>
                <label>Qty</label><input type="number" id="add-qty" value="1">
                <button class="action-btn" onclick="saveStock()">ADD TO INVENTORY</button>
            </div>
        </div>
    </section>

    <section id="records" class="hidden">
        <div class="sub-nav">
            <button onclick="renderReport('All')">ALL</button>
            <button onclick="renderReport('Accessory')">STOCKS</button>
            <button onclick="renderReport('Phone')">PHONES</button>
            <button onclick="renderReport('Repair')">REPAIR</button>
        </div>
        <div id="report-sum" class="card" style="background:#f8fafc; border-left:6px solid var(--primary)"></div>
        <div id="report-list"></div>
    </section>
</div>

<nav class="bottom-nav">
    <button class="nav-item active" id="btn-das" onclick="changeTab('dashboard')"><span>üè†</span>Dash</button>
    <button class="nav-item" id="btn-sal" onclick="changeTab('sales-entry')"><span>‚ûï</span>Sale</button>
    <button class="nav-item" id="btn-inv" onclick="changeTab('inventory')"><span>üì¶</span>Stock</button>
    <button class="nav-item" id="btn-rec" onclick="changeTab('records')"><span>üìä</span>Report</button>
</nav>

<script>
    const CLOUD_URL = "https://script.google.com/macros/s/AKfycbwdKHtI0gT9gcfrH74uh6-CqAzezEEUxsanQIxuJKeG00bQVfVxGfb5EuZf6qT3WhCN/exec"; 
    
    const db = new Dexie("EliteShop_Pro_V7_Restore");
    db.version(1).stores({ 
        records: '++id, date, cat, item, buy, sell, status', 
        inventory: '++id, type, sub, name, buy, sell, qty, specs, cond' 
    });

    // --- SYNC ENGINE (FIXED DATA LOADING) ---
    async function syncToCloud() {
        const dot = document.getElementById('sync-dot');
        dot.style.background = 'var(--syncing)';
        dot.style.boxShadow = '0 0 15px var(--syncing)';
        
        try {
            const records = await db.records.toArray(); 
            const inventory = await db.inventory.toArray();
            
            // Fixed payload: Single object, no double brackets
            const payload = JSON.stringify({ records, inventory });
            
            await fetch(CLOUD_URL, { 
                method: 'POST', 
                mode: 'no-cors', // Essential for mobile
                headers: { 'Content-Type': 'text/plain' },
                body: payload 
            });

            // Blue dot stays for 5 seconds as requested
            setTimeout(() => {
                dot.style.background = 'var(--success)';
                dot.style.boxShadow = '0 0 8px var(--success)';
            }, 5000);

        } catch(e) { 
            console.error(e);
            dot.style.background = 'var(--danger)'; 
        }
    }

    async function syncFromCloud() {
        if(!confirm("Pull data from cloud?")) return;
        try {
            const r = await fetch(CLOUD_URL); 
            const d = await r.json();
            // Checking if data exists in Cell A1
            if(d && d[0] && d[0][0]) {
                const p = JSON.parse(d[0][0]); 
                await db.records.clear(); await db.inventory.clear();
                await db.records.bulkAdd(p.records); await db.inventory.bulkAdd(p.inventory); 
                location.reload();
            }
        } catch(e) { alert("Sync failed. Ensure Google Sheet has data."); }
    }

    // --- LOGIC FUNCTIONS ---
    function updateUI() {
        const c = document.getElementById('sale-cat').value;
        document.getElementById('ui-standard').className = (c==='Accessory'||c==='Phone')?'':'hidden';
        document.getElementById('ui-repair').className = (c==='Repair')?'':'hidden';
        document.getElementById('ui-pawn').className = (c==='Pawn')?'':'hidden';
        document.getElementById('ui-expense').className = (c==='Expense')?'':'hidden';
    }

    function updateAddUI() {
        const t = document.getElementById('add-type').value;
        document.getElementById('add-acc-fields').className = (t==='Accessory')?'':'hidden';
        document.getElementById('add-phone-fields').className = (t==='Phone')?'':'hidden';
    }

    function checkCustom() {
        document.getElementById('add-custom').className = (document.getElementById('add-sub').value==='CUSTOM')?'':'hidden';
    }

    async function saveStock() {
        const t = document.getElementById('add-type').value;
        let s = document.getElementById('add-sub').value;
        if(t==='Accessory' && s==='CUSTOM') s = document.getElementById('add-custom').value;
        
        const item = {
            type: t, name: document.getElementById('add-name').value,
            buy: parseFloat(document.getElementById('add-buy').value)||0,
            sell: parseFloat(document.getElementById('add-sell').value)||0,
            qty: parseInt(document.getElementById('add-qty').value)||1,
            sub: t==='Accessory'?s:'', cond: t==='Phone'?document.getElementById('add-cond').value:'',
            specs: t==='Phone'?document.getElementById('add-specs').value:''
        };
        if(!item.name) return alert("Enter item name");
        await db.inventory.add(item); 
        await syncToCloud();
        
        // Auto-Clear
        document.getElementById('add-name').value = ""; document.getElementById('add-buy').value = "";
        document.getElementById('add-sell').value = ""; document.getElementById('add-qty').value = "1";
        document.getElementById('add-specs').value = "";
        
        switchInv(t==='Accessory'?'acc':'phone');
    }

    async function switchInv(tab) {
        document.querySelectorAll('#inventory .sub-nav button').forEach(b => b.classList.remove('active'));
        document.getElementById('inv-tab-'+tab).classList.add('active');
        document.getElementById('inv-list-container').className = (tab==='add')?'hidden':'';
        document.getElementById('inv-add-container').className = (tab==='add')?'':'hidden';
        if(tab!=='add') renderInv(tab);
    }

    async function renderInv(tab='acc') {
        const search = document.getElementById('inv-search').value.toLowerCase();
        const items = await db.inventory.toArray();
        let h = '';
        if(tab==='acc') {
            items.filter(i=>i.type==='Accessory'&&i.name.toLowerCase().includes(search)).forEach(i=>{
                h += `<div class="card"><b>${i.name}</b> <small>(${i.sub})</small><br><small>Qty: ${i.qty} | Sell: $${i.sell}</small>
                <div class="control-panel"><button class="btn-edit" onclick="editI(${i.id})">Edit</button><button class="btn-delete" onclick="delI(${i.id})">Del</button></div></div>`;
            });
        } else if(tab==='phone') {
            items.filter(i=>i.type==='Phone'&&i.name.toLowerCase().includes(search)).forEach(i=>{
                h += `<div class="card"><b>${i.name}</b> [${i.cond}]<br><small>${i.specs} | Stock: ${i.qty}</small>
                <div class="control-panel"><button class="btn-edit" onclick="editI(${i.id})">Edit</button><button class="btn-delete" onclick="delI(${i.id})">Del</button></div></div>`;
            });
        } else if(tab==='pawn') {
            const pawns = await db.records.where('cat').equals('Pawn').toArray();
            pawns.forEach(p=>{
                h += `<div class="card"><b>${p.item}</b> <span class="badge" style="background:${p.status==='In Shop'?'var(--warning)':'var(--success)'}; color:white">${p.status}</span><br><small>Loan: $${p.buy}</small>
                <div class="control-panel"><button class="btn-edit" onclick="toggleP(${p.id},'${p.status}')">Status</button><button class="btn-delete" onclick="delR(${p.id})">Del</button></div></div>`;
            });
        }
        document.getElementById('inv-render').innerHTML = h || '<p style="text-align:center; opacity:0.5">Empty</p>';
    }

    async function delI(id) { if(confirm("Delete Item?")) { await db.inventory.delete(id); await syncToCloud(); renderInv(); } }
    async function editI(id) {
        const i = await db.inventory.get(id); 
        const nQ = prompt("New Qty", i.qty); 
        const nS = prompt("New Price", i.sell);
        if(nQ !== null && nS !== null) { 
            await db.inventory.update(id, {qty: parseInt(nQ), sell: parseFloat(nS)}); 
            await syncToCloud(); renderInv(); 
        }
    }

    async function saveSale() {
        const cat = document.getElementById('sale-cat').value;
        const date = document.getElementById('sale-date').value || new Date().toISOString().split('T')[0];
        let d = { date, cat, status: 'Completed' };
        if(cat==='Accessory'||cat==='Phone') {
            const name = document.getElementById('sale-item-name').value;
            const s = await db.inventory.where('name').equals(name).first();
            const q = parseInt(document.getElementById('sale-qty').value)||1;
            d.item = name; d.sell = parseFloat(document.getElementById('sale-price').value)||0; d.buy = (s?s.buy:0)*q;
            if(s) await db.inventory.update(s.id, {qty: s.qty - q});
        } else if(cat==='Repair') {
            d.item = "Rep: "+document.getElementById('rep-desc').value; d.buy = parseFloat(document.getElementById('rep-cost').value)||0; d.sell = parseFloat(document.getElementById('rep-charge').value)||0;
        } else if(cat==='Pawn') {
            d.item = document.getElementById('pawn-info').value; d.buy = parseFloat(document.getElementById('pawn-loan').value)||0; d.sell = parseFloat(document.getElementById('pawn-interest').value)||0; d.status = 'In Shop';
        } else if(cat==='Expense') {
            d.item = "Exp: "+document.getElementById('exp-name').value; d.buy = parseFloat(document.getElementById('exp-amount').value)||0; d.sell = 0;
        }
        await db.records.add(d); 
        await syncToCloud();
        changeTab('dashboard');
    }

    async function toggleP(id, s) { await db.records.update(id, {status: s==='In Shop'?'Collected':'In Shop'}); await syncToCloud(); renderInv('pawn'); }
    async function delR(id) { if(confirm("Delete record?")) { await db.records.delete(id); await syncToCloud(); renderReport(); } }

    async function autoFill() {
        const n = document.getElementById('sale-item-name').value;
        const i = await db.inventory.where('name').equals(n).first();
        if(i) { document.getElementById('sale-price').value = i.sell; document.getElementById('sale-cat').value = i.type; updateUI(); }
    }

    async function renderReport(f='All') {
        let r = await db.records.toArray(); if(f!=='All') r = r.filter(x=>x.cat===f);
        let sT=0, pT=0;
        r.forEach(x=>{ if(x.cat==='Pawn'&&x.status!=='Collected') return; sT += x.sell; pT += (x.sell-x.buy); });
        document.getElementById('report-sum').innerHTML = `<b>${f} Summary</b><br>Rev: $${sT.toFixed(2)} | Profit: $${pT.toFixed(2)}`;
        document.getElementById('report-list').innerHTML = r.reverse().map(x=>`<div class="card"><b>${x.item}</b> <span style="float:right">$${x.sell||x.buy}</span><br><small>${x.date}</small>
        <div class="control-panel"><button class="btn-delete" onclick="delR(${x.id})">Delete</button></div></div>`).join('');
    }

    async function dash() {
        const today = new Date().toISOString().split('T')[0];
        const r = await db.records.toArray(); const i = await db.inventory.toArray();
        let sT=0, pT=0, eT=0, cT=0, iV=0;
        r.forEach(x=>{ const ok = (x.cat!=='Pawn'||x.status==='Collected'); if(x.date===today&&ok){ sT += x.sell; pT += (x.sell-x.buy); } if(ok){ eT += x.sell; cT += x.buy; } });
        i.forEach(x=> iV += (x.buy*x.qty));
        document.getElementById('dash-sales').innerText = `$${sT.toFixed(2)}`;
        document.getElementById('dash-profit').innerText = `$${pT.toFixed(2)}`;
        document.getElementById('fin-invest').innerText = `$${iV.toFixed(2)}`;
        document.getElementById('fin-earn').innerText = `$${eT.toFixed(2)}`;
        document.getElementById('fin-net').innerText = `$${(eT-cT).toFixed(2)}`;
    }

    async function changeTab(t) {
        document.querySelectorAll('section').forEach(s=>s.classList.add('hidden'));
        document.getElementById(t).classList.remove('hidden');
        document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
        const m = {dashboard:'das', 'sales-entry':'sal', inventory:'inv', records:'rec'};
        document.getElementById('btn-'+m[t]).classList.add('active');
        if(t==='dashboard') dash(); if(t==='inventory') switchInv('acc'); if(t==='records') renderReport('All');
        if(t==='sales-entry') { const l = await db.inventory.toArray(); document.getElementById('stock-datalist').innerHTML = l.map(x=>`<option value="${x.name}">`).join(''); document.getElementById('sale-date').value = new Date().toISOString().split('T')[0]; }
    }

    function generatePDF() { const { jsPDF } = window.jspdf; const doc = new jsPDF(); doc.text("Profit Report", 20, 20); doc.text("Net: " + document.getElementById('fin-net').innerText, 20, 35); doc.save("Report.pdf"); }

    changeTab('dashboard');
</script>
</body>
</html>
