<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Elite Shop Manager Pro - Version 11.0</title>
    
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style> 
    /* 1. TARGETING THE OPTIONS DROPDOWN & SELECT BOXES */
    select, 
    option, 
    .options-btn, 
    .options-menu,
    [class*="options"] { 
        background: transparent !important; 
        background-color: transparent !important;
        color: white !important; 
        border: 1px solid rgba(255, 255, 255, 0.3) !important;
        backdrop-filter: none !important;
        -webkit-appearance: none; 
    }

    select option { 
        background: rgba(0, 0, 0, 0.8) !important; 
        color: white !important; 
    }

    :root { 
        --primary: #77777777; 
        --success: #10b981; 
        --danger: #ef4444; 
        --warning: #f59e0b; 
    }

    /* 2. THE WALLPAPER */
    html, body { 
        margin: 0; padding: 0; min-height: 100vh;
        background: linear-gradient(rgba(0, 0, 0, 0.65), rgba(0, 0, 0, 0.65)), 
                    url('https://raw.githubusercontent.com/RAJUPOKHREL/RJshop/refs/heads/main/5153888.jpg') 
                    no-repeat center center fixed !important;
        background-size: cover !important;
        font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
        padding-bottom: 120px; color: white; -webkit-tap-highlight-color: transparent;
    }

    /* 3. HEADER & FLOATING PILL NAV */
    .header { padding: 15px 20px; background: transparent !important; backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255, 255, 255, 0.1); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; }

    .bottom-nav { 
        position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; height: 70px; 
        background: rgba(0, 0, 0, 0.7) !important; backdrop-filter: blur(25px); display: flex; justify-content: space-around; 
        align-items: center; border: 1px solid rgba(255, 255, 255, 0.1) !important; z-index: 1000; border-radius: 40px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    .nav-item { background: transparent !important; border: none !important; color: rgba(255, 255, 255, 0.6) !important; padding: 10px 15px; display: flex; flex-direction: column; align-items: center; transition: 0.3s; font-size: 12px; }
    .nav-item.active { color: white !important; background: rgba(255, 255, 255, 0.15) !important; border-radius: 20px; }

    /* 4. CARDS (100% CLARITY - NO BLUR) */
    .card, .dash-dark-card, .report-summary-card, .date-pager { 
        background: rgba(255, 255, 255, 0.03) !important; 
        backdrop-filter: none !important; 
        border: 1px solid rgba(255, 255, 255, 0.1) !important; 
        padding: 18px; border-radius: 20px; margin-bottom: 15px; box-sizing: border-box; overflow: hidden;
    }

    /* 5. NEXT / DATE / PREV LAYOUT (FIXED TO ONE LINE) */
    .pager-controls { 
        display: flex !important; 
        flex-direction: row !important; /* Forces horizontal line */
        align-items: center !important; 
        justify-content: space-between !important; 
        gap: 10px; 
    }
    .pager-controls span { 
        flex: 1; 
        text-align: center; 
        font-weight: 800; 
        font-size: 14px; 
    }
    .prev-btn, .next-btn { width: auto !important; flex: 0 0 auto !important; }

    /* 6. BUTTONS (100% TRANSPARENT) */
    #generate-pdf-btn, .action-btn, .date-pager button, .control-panel button, #pull-btn, .prev-btn, .next-btn { 
        background: transparent !important; 
        color: white !important; 
		box-shadow : 0 4px 15px rgba(0,0,0,0.3)
        border: 1px solid rgba(255, 255, 255, 0.3) !important; 
        backdrop-filter: none !important;
        padding: 12px 18px; border-radius: 12px; font-weight: 800; cursor: pointer;
        transition: 0.3s ease;
    }
	/* SPECIFICALLY CENTER THE MAIN ACTION BUTTONS */
.action-btn, #save-inv-btn {
    display: block !important;
    width: 50% !important; /* Slightly smaller than full width looks better */
    margin: 30px auto !important; /* Adds space above and below */
    
    /* THE TRICK TO FORCE CENTER */
    position: relative !important;
    left: 23% !important;
    transform: translateX(-50%) !important;
    
    text-align: center !important;
    white-space: nowrap;
}
/* FIX FOR PDF BUTTON ONLY */
    #generate-pdf-btn {
        background: white !important; 
        color: #1a1a1a !important; /* Dark text for white background */
        border: 2px solid #e2e8f0 !important;
        
        /* CENTER IT LIKE THE OTHERS */
        display: block !important;
        width: 85% !important;
        margin: 20px auto !important;
        position: relative !important;
        left: 50% !important;
        transform: translateX(-50%) !important;

        /* MOBILE FIXES */
        white-space: normal !important; /* Allows text to wrap to 2 lines */
        height: auto !important;        /* Let button grow with text */
        padding: 12px 10px !important;  /* Balanced padding */
        font-size: 13px !important;     /* Slightly smaller for mobile */
        font-weight: 800 !important;
        line-height: 1.3 !important;
    }

    /* 7. ELITE GRID & INPUTS */
    .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px; }
    .mini-stat { 
        padding: 20px; border-radius: 22px; display: flex; flex-direction: column;
        background: rgba(255, 255, 255, 0.05) !important; border: 1px solid rgba(255, 255, 255, 0.1) !important;
    }
    .mini-stat strong { font-size: 24px; font-weight: 900; }
    
    input, select, textarea { 
        width: 100% !important; box-sizing: border-box !important; padding: 16px; margin-bottom: 12px; border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.2) !important; background: transparent !important; color: white !important;
    }

    /* 8. TAB LOGIC & UTILS */
    .hidden { display: none !important; }
    .container { padding: 15px; max-width: 600px; margin: auto; }
    h1, h2, h3, strong, label { color: white !important; }

    .sub-nav { display: flex; gap: 8px; margin-bottom: 15px; background: rgba(255,255,255,0.05); padding: 6px; border-radius: 15px; }
    .sub-nav button { flex: 1; border: none; padding: 12px; border-radius: 10px; font-weight: 700; color: white; opacity: 0.5; background: none; }
    .sub-nav button.active { background: var(--primary); opacity: 1; }
	/* NEW: QUANTITY & PRICE SIDE-BY-SIDE */
    .sales-row {
        display: flex;
        gap: 12px;
        width: 100%;
        margin-bottom: 5px;
    }
    .sales-row > div {
        flex: 1;
    }

    /* NEW: BIGGER CHECKBOX */
    input[type="checkbox"] {
        width: 30px !important;
        height: 30px !important;
        cursor: pointer;
        accent-color: var(--success); /* Makes the check mark green */
        vertical-align: middle;
    }
</style>
</head>
<body>

<div class="header">
    <h1 style="font-size: 22px; margin:0; font-weight: 950; letter-spacing: -1.2px;">ELITE SHOP PRO</h1>
    <div style="display:flex; align-items:center; gap:15px;">
        <button class="sync-btn" onclick="syncFromCloud()">üîÑ PULL</button>
        <div class="status-dot" id="sync-dot"></div>
    </div>
</div>

<div class="container">
    
    <section id="dashboard">
        <div class="stat-grid">
            <div class="mini-stat" style="background: var(--primary);">
                <small>Today's Sales</small>
                <strong id="dash-sales">$0.00</strong>
            </div>
            <div class="mini-stat" style="background: var(--success);">
                <small>Today's Profit</small>
                <strong id="dash-profit">$0.00</strong>
            </div>
        </div>

        <div class="dash-dark-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin: 0; color: var(--warning); font-size: 13px; text-transform: uppercase; letter-spacing: 1px;">Shop Overview</h3>
                <span class="calendar-icon" onclick="toggleDashFilter()">üìÖ Range</span>
            </div>

            <div id="dash-filter-area" class="dash-filter-container hidden">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div><label>From</label><input type="date" id="dash-from" onchange="refreshDashboardMetrics()"></div>
                    <div><label>To</label><input type="date" id="dash-to" onchange="refreshDashboardMetrics()"></div>
                </div>
                <button onclick="clearDashFilter()" style="width:100%; border:none; padding:8px; border-radius:8px; background:var(--danger); color:white; font-size:10px; font-weight:900;">CLEAR FILTER</button>
            </div>

           <div style="display:flex; flex-direction:column; gap:12px; font-size:14px;">
    
    <div style="display:flex; justify-content:space-between;">
        <span style="opacity:0.8">Total Stock Invested:</span> 
        <span id="fin-total-invest" style="font-weight:700">$0.00</span>
    </div>

    <div style="display:flex; justify-content:space-between;">
        <span style="opacity:0.8">Inventory Value (Remaining):</span> 
        <span id="fin-invest" style="font-weight:700">$0.00</span>
    </div>

    <hr style="opacity:0.1; margin: 5px 0;">

    <div style="display:flex; justify-content:space-between;">
        <span style="opacity:0.8">Service Expense:</span> 
        <span id="fin-serv-exp" style="color:#ff6b6b; font-weight:700">$0.00</span>
    </div>

    <div style="display:flex; justify-content:space-between;">
        <span style="opacity:0.8">General Expense:</span> 
        <span id="fin-gen-exp" style="color:#ff6b6b; font-weight:700">$0.00</span>
    </div>

    <div style="display:flex; justify-content:space-between;">
        <span style="opacity:0.8">Total Revenue:</span> 
        <span id="fin-earn" style="color:var(--success); font-weight:700">$0.00</span>
    </div>

    <div style="display:flex; justify-content:space-between; background: rgba(33, 150, 243, 0.1); padding: 10px; border-radius: 8px; margin-top: 5px;">
        <span style="opacity:0.8; font-weight:bold;">Cash in Hand:</span> 
        <span id="dash-cash" style="font-weight:900; color: var(--success);">$0.00</span>
    </div>

    <hr style="opacity:0.15; margin: 10px 0;">

    <div style="display:flex; justify-content:space-between; align-items: center;">
        <span style="font-weight:700; font-size: 14px;">NET PROFIT:</span> 
        <span id="fin-net" style="font-weight:950; font-size:26px; color:var(--success)">$0.00</span>
    </div>
</div>
        </div>
        
        <button class="action-btn" onclick="generatePDF()">üì• GENERATE BUSINESS PDF</button>
    </section>

    <section id="sales-entry" class="hidden">
        <div class="card">
            <label>Transaction Date</label>
            <input type="date" id="sale-date">
            
            <label>Transaction Category</label>
            <select id="sale-cat" onchange="updateEntryUIVisibility()">
                <option value="Accessory">Product/Stock Sale</option>
                <option value="Phone">Phone Sale</option>
                <option value="Repair">Repair / Service</option>
                <option value="ServiceExpense">Service Expense (Unlock Tools/Credits)</option>
                <option value="Pawn">Pawn Entry</option>
                <option value="Expense">Expense / Bill</option>
            </select>

            <div id="ui-standard">
                <label>Find Item in Stock</label>
                <input list="stock-datalist" id="sale-item-name" onchange="handleSaleAutoFill()" placeholder="Search product name...">
                <datalist id="stock-datalist"></datalist>
                <div style="display:flex; gap:12px; align-items: flex;">
                    <div style="flex:1;"><label>Quantity</label><input type="number" id="sale-qty" value="1"></div>
                    <div style="flex:2;">
                        <label>Selling Price</label>
                        <input type="number" id="sale-price">
                        <div class="check-group">
                            <input type="checkbox" id="sale-per-unit">
                            <label for="sale-per-unit">Per Unit (Auto Calc)</label>
                        </div>
                    </div>
                </div>
            </div>

            <div id="ui-repair" class="hidden">
                <label>Repair Details</label>
                <input type="text" id="rep-desc" placeholder="Device Model & Fault">
                <div style="display:flex; gap:12px;">
                    <div style="flex:1;"><label>Parts Cost</label><input type="number" id="rep-cost" placeholder="0.00"></div>
                    <div style="flex:1;"><label>Price Charged</label><input type="number" id="rep-charge" placeholder="0.00"></div>
                </div>
            </div>

            <div id="ui-pawn" class="hidden">
                <label>Pawn Item / Customer Name</label>
                <input type="text" id="pawn-info" placeholder="Name - Model - ID">
                <div style="display:flex; gap:12px;">
                    <div style="flex:1;"><label>Loan Amount</label><input type="number" id="pawn-loan" placeholder="0.00"></div>
                    <div style="flex:1;"><label>Interest Fee</label><input type="number" id="pawn-interest" placeholder="0.00"></div>
                </div>
            </div>

            <div id="ui-expense" class="hidden">
                <label>Reason / Item Name</label>
                <input type="text" id="exp-name" placeholder="Unlock Tool, Credits, Rent, Electricity...">
                <label>Total Amount Paid</label>
                <input type="number" id="exp-amount" placeholder="0.00">
            </div>

            <button class="action-btn" onclick="processTransaction()">SAVE TRANSACTION</button>
        </div>
    </section>

    <section id="inventory" class="hidden">
        <div class="sub-nav">
            <button id="inv-tab-acc" class="active" onclick="switchInventorySubTab('acc')">STOCKS</button>
            <button id="inv-tab-phone" onclick="switchInventorySubTab('phone')">PHONES</button>
            <button id="inv-tab-pawn" onclick="switchInventorySubTab('pawn')">PAWNS</button>
            <button id="inv-tab-add" onclick="switchInventorySubTab('add')">+ NEW ENTRY</button>
        </div>

        <div id="inv-list-container">
            <input type="text" id="inv-search-box" placeholder="üîç Search stock items..." onkeyup="refreshInventoryDisplay()">
            <div id="inv-render-target"></div>
        </div>

        <div id="inv-add-container" class="hidden">
            <div class="card">
                <label>Item Category Type</label>
                <select id="add-main-type" onchange="updateAddStockUIVisibility()">
                    <option value="Accessory">Accessory / General Product</option>
                    <option value="Phone">Smartphone / Tablet</option>
                </select>

                <div id="add-form-accessory">
                    <label>Sub-Type / Brand</label>
                    <select id="add-sub-select" onchange="handleCustomCategoryToggle()">
                        <option>V8 Cable</option>
                        <option>Type-C Cable</option>
                        <option>Earphone</option>
                        <option>Airpods</option>
                        <option>Charger</option>
                        <option value="CUSTOM">-- WRITE CUSTOM CATEGORY --</option>
                    </select>
                    <input type="text" id="add-custom-cat-input" class="hidden" placeholder="Enter custom category name...">
                </div>

                <div id="add-form-phone" class="hidden">
                    <label>Device Condition</label>
                    <select id="add-phone-condition">
                        <option>Brand New</option>
                        <option>Second Hand</option>
                        <option>Refurbished</option>
                    </select>
                    <label>Hardware Specifications</label>
                    <input type="text" id="add-phone-specs" placeholder="e.g. 8GB/256GB - Blue">
                </div>

                <label>Full Product Name</label>
                <input type="text" id="add-item-name">
                
                <div style="display:flex; gap:12px;">
                    <div style="flex:1;"><label>Buy Price</label><input type="number" id="add-buy-price" placeholder="0.00"></div>
                    <div style="flex:1;"><label>Sell Price</label><input type="number" id="add-sell-price" placeholder="0.00"></div>
                </div>
                
                <label>Starting Quantity</label>
                <input type="number" id="add-stock-qty" value="1">

                <button class="action-btn" onclick="saveNewStockItem()">ADD TO INVENTORY</button>
            </div>
        </div>
    </section>

    <section id="records" class="hidden">
        <div class="date-pager">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <b id="pager-mode-title" style="font-size:11px; color:var(--primary)">DAILY VIEW</b>
                <button onclick="toggleReportMode()" style="font-size:10px; border:none; background:#eee; padding:5px 10px; border-radius:5px; font-weight:bold;">SWITCH RANGE</button>
            </div>
            
            <div id="pager-daily" class="pager-controls">
                <button class="pager-btn" onclick="changeReportDate(-1)">‚Üê PREV</button>
                <input type="date" id="report-date-input" style="margin:0; flex:1;" onchange="refreshReportDisplay()">
                <button class="pager-btn" onclick="changeReportDate(1)">NEXT ‚Üí</button>
            </div>

            <div id="pager-range" class="range-controls hidden">
                <input type="date" id="rep-from" onchange="refreshReportDisplay()">
                <input type="date" id="rep-to" onchange="refreshReportDisplay()">
            </div>
        </div>

        <div class="sub-nav">
            <button id="rep-all-btn" class="active" onclick="setReportFilter('All')">ALL</button>
            <button onclick="setReportFilter('Repair')">REPAIRS</button>
            <button onclick="setReportFilter('ServiceExpense')">SVC EXP</button>
            <button onclick="setReportFilter('Accessory')">STOCKS</button>
            <button onclick="setReportFilter('Expense')">GENERAL</button>
        </div>

        <div id="report-financial-summary" class="report-summary-card"></div>
        <div id="report-items-list"></div>
    </section>
</div>

<nav class="bottom-nav">
    <button class="nav-item active" id="btn-das" onclick="changeGlobalTab('dashboard')"><span>üè†</span>Dash</button>
    <button class="nav-item" id="btn-sal" onclick="changeGlobalTab('sales-entry')"><span>‚ûï</span>Sale</button>
    <button class="nav-item" id="btn-inv" onclick="changeGlobalTab('inventory')"><span>üì¶</span>Stock</button>
    <button class="nav-item" id="btn-rec" onclick="changeGlobalTab('records')"><span>üìä</span>Report</button>
</nav>

<script>
    const CLOUD_URL = "https://script.google.com/macros/s/AKfycbx-WiIzIzSlALp5EB3O9RUDHNRTb56J7F-Xa4i-931xT89tZbmT_WzACV2bFH3rxnQz/exec";
    const db = new Dexie("EliteShop_Pro_V11_Final");
    
    db.version(1).stores({ 
        records: '++id, date, cat, item, buy, sell, status, qty',
        inventory: '++id, type, sub, name, buy, sell, qty, specs, cond'
    });

    let currentReportFilter = 'All';
    let reportViewMode = 'daily';
    const getFormattedToday = () => new Date().toISOString().split('T')[0];

    // DASHBOARD RANGE LOGIC
    function toggleDashFilter() {
        document.getElementById('dash-filter-area').classList.toggle('hidden');
    }
    function clearDashFilter() {
        document.getElementById('dash-from').value = "";
        document.getElementById('dash-to').value = "";
        refreshDashboardMetrics();
    }

    // CLOUD SYNC LOGIC
    async function syncToCloud() {
        const dot = document.getElementById('sync-dot');
        dot.style.background = 'var(--syncing)';
        try {
            const records = await db.records.toArray();
            const inventory = await db.inventory.toArray();
            const payload = [[JSON.stringify({ records, inventory })]];
            await fetch(CLOUD_URL, { method: 'POST', body: JSON.stringify(payload) });
            dot.style.background = 'var(--success)';
        } catch(e) { dot.style.background = 'var(--danger)'; }
    }

    async function syncFromCloud() {

        if(!confirm("Pull cloud data? This will overwrite local data.")) return;

        try {

            const response = await fetch(CLOUD_URL);

            const data = await response.json();

            if(data && data[0][0]) {

                const parsed = JSON.parse(data[0][0]);

               // .put() is the key for the 10 -> 8 update. 
// It updates the item if the ID matches, instead of crashing.
await db.records.bulkPut(parsed.records || []); 
await db.inventory.bulkPut(parsed.inventory || []);
                location.reload();

            }

        } catch(e) { alert("Error pulling data."); }

    }

    // ENTRY LOGIC
    function updateEntryUIVisibility() {
        const cat = document.getElementById('sale-cat').value;
        document.getElementById('ui-standard').className = (cat === 'Accessory' || cat === 'Phone') ? '' : 'hidden';
        document.getElementById('ui-repair').className = (cat === 'Repair') ? '' : 'hidden';
        document.getElementById('ui-pawn').className = (cat === 'Pawn') ? '' : 'hidden';
        document.getElementById('ui-expense').className = (cat === 'Expense' || cat === 'ServiceExpense') ? '' : 'hidden';
    }

    async function handleSaleAutoFill() {
        const val = document.getElementById('sale-item-name').value;
        const item = await db.inventory.where('name').equals(val).first();
        if(item) {
            document.getElementById('sale-price').value = item.sell;
            document.getElementById('sale-cat').value = item.type;
            updateEntryUIVisibility();
        }
    }

    async function processTransaction() {
        const cat = document.getElementById('sale-cat').value;
        const date = document.getElementById('sale-date').value || getFormattedToday();
        let data = { date, cat, status: 'Completed', qty: 1 };

        if(cat === 'Accessory' || cat === 'Phone') {
            const name = document.getElementById('sale-item-name').value;
            const stock = await db.inventory.where('name').equals(name).first();
            const qty = parseInt(document.getElementById('sale-qty').value) || 1;
            const price = parseFloat(document.getElementById('sale-price').value) || 0;
            data.qty = qty;
            data.item = name;
            data.sell = document.getElementById('sale-per-unit').checked ? (price * qty) : price;
            data.buy = (stock ? stock.buy : 0) * qty;
            if(stock) await db.inventory.update(stock.id, { qty: stock.qty - qty });
        } else if(cat === 'Repair') {
            data.item = "Service: " + document.getElementById('rep-desc').value;
            data.buy = parseFloat(document.getElementById('rep-cost').value) || 0;
            data.sell = parseFloat(document.getElementById('rep-charge').value) || 0;
        } else if(cat === 'Pawn') {
            data.item = "Pawn: " + document.getElementById('pawn-info').value;
            data.buy = parseFloat(document.getElementById('pawn-loan').value) || 0;
            data.sell = parseFloat(document.getElementById('pawn-interest').value) || 0;
            data.status = 'In Shop';
        } else {
            data.item = (cat === 'ServiceExpense' ? "SrvTool: " : "Exp: ") + document.getElementById('exp-name').value;
            data.buy = parseFloat(document.getElementById('exp-amount').value) || 0;
            data.sell = 0;
        }

        if(!data.item) return;
       await db.records.add(data);
syncToCloud();

// CLEAR ALL INPUTS
document.getElementById('sale-item-name').value = '';
document.getElementById('sale-price').value = '';
document.getElementById('rep-desc').value = '';
document.getElementById('rep-cost').value = '';
document.getElementById('rep-charge').value = '';
document.getElementById('exp-name').value = '';
document.getElementById('exp-amount').value = '';

changeGlobalTab('dashboard');
    }

    // INVENTORY LOGIC
    function updateAddStockUIVisibility() {
        const type = document.getElementById('add-main-type').value;
        document.getElementById('add-form-accessory').className = (type === 'Accessory') ? '' : 'hidden';
        document.getElementById('add-form-phone').className = (type === 'Phone') ? '' : 'hidden';
    }

    function handleCustomCategoryToggle() {
        const val = document.getElementById('add-sub-select').value;
        document.getElementById('add-custom-cat-input').className = (val === 'CUSTOM') ? '' : 'hidden';
    }

    async function saveNewStockItem() {
        const type = document.getElementById('add-main-type').value;
        let sub = document.getElementById('add-sub-select').value;
        if(type === 'Accessory' && sub === 'CUSTOM') sub = document.getElementById('add-custom-cat-input').value;

        const entry = {
            type, name: document.getElementById('add-item-name').value,
            buy: parseFloat(document.getElementById('add-buy-price').value) || 0,
            sell: parseFloat(document.getElementById('add-sell-price').value) || 0,
            qty: parseInt(document.getElementById('add-stock-qty').value) || 0,
            sub: type === 'Accessory' ? sub : '',
            cond: type === 'Phone' ? document.getElementById('add-phone-condition').value : '',
            specs: type === 'Phone' ? document.getElementById('add-phone-specs').value : ''
        };
        if(!entry.name) return;
        await db.inventory.add(entry);
syncToCloud();

// CLEAR ALL INPUTS
document.getElementById('add-item-name').value = '';
document.getElementById('add-buy-price').value = '';
document.getElementById('add-sell-price').value = '';
document.getElementById('add-stock-qty').value = '1';
document.getElementById('add-phone-specs').value = '';
document.getElementById('add-custom-cat-input').value = '';

alert("Added!");
    }

    async function refreshInventoryDisplay(tab = 'acc') {
    const search = document.getElementById('inv-search-box').value.toLowerCase();
    const items = await db.inventory.toArray();
    let html = '';

    if(tab === 'acc') {
        html = items.filter(i => i.type === 'Accessory' && i.name.toLowerCase().includes(search)).map(i => `
            <div class="card">
                <b>${i.name}</b> <small>(${i.sub})</small><br>
                <small>Qty: ${i.qty} | Buy: $${i.buy} | Sell: $${i.sell}</small>
                <div class="control-panel">
                    <button class="btn-edit" onclick="modifyStock(${i.id})">Edit</button>
                    <button class="btn-delete" onclick="deleteStock(${i.id})">Delete</button>
                </div>
            </div>`).join('');
    } else if(tab === 'phone') {
        html = items.filter(i => i.type === 'Phone' && i.name.toLowerCase().includes(search)).map(i => `
            <div class="card">
                <b>${i.name}</b> <span class="badge" style="background:#eee">${i.cond}</span><br>
                <small>${i.specs}</small><br>
                <small>Qty: ${i.qty} | Price: $${i.sell}</small>
                <div class="control-panel">
                    <button class="btn-edit" onclick="modifyStock(${i.id})">Edit</button>
                    <button class="btn-delete" onclick="deleteStock(${i.id})">Delete</button>
                </div>
            </div>`).join('');
    } else if(tab === 'pawn') {
        const pawns = await db.records.where('cat').equals('Pawn').toArray();
        html = pawns.map(p => `
            <div class="card">
                <b>${p.item}</b> <span class="badge" style="float:right; background:${p.status === 'In Shop' ? 'var(--warning)' : 'var(--success)'}; color:white">${p.status}</span><br>
                <small>Loan: $${p.buy} | Int: $${p.sell}</small>
                <div class="control-panel">
                    <button class="btn-edit" onclick="togglePawn(${p.id},'${p.status}')">Toggle Status</button>
                    <button class="btn-delete" onclick="deleteRec(${p.id})">Delete</button>
                </div>
            </div>`).join('');
    }
    document.getElementById('inv-render-target').innerHTML = html;
}
    async function togglePawn(id, s) {
        await db.records.update(id, { status: s === 'In Shop' ? 'Collected' : 'In Shop' });
        refreshInventoryDisplay('pawn');
    }

    // DASHBOARD & REPORT REFRESH
    async function refreshDashboardMetrics() {
    let from = document.getElementById('dash-from').value;
    let to = document.getElementById('dash-to').value;
    
    // 1. IMPROVEMENT: If no date is selected, default to TODAY 
    // This stops it from showing $0 or "Total History" on startup
    if(!from || !to) {
        const today = new Date().toISOString().split('T')[0];
        from = today;
        to = today;
    }
    
    let allRecs = await db.records.toArray();
    const inv = await db.inventory.toArray();
    
    // Filter by Date
    let filteredRecs = allRecs.filter(r => r.date >= from && r.date <= to);

    let totalRevenue = 0;
    let serviceExpense = 0;
    let generalExpense = 0;
    let totalStockInvested = 0; 
    let currentInventoryValue = 0; 

    // CALCULATE FROM FILTERED RECORDS
    filteredRecs.forEach(r => {
        if(r.cat === 'Expense') {
            generalExpense += (r.buy || 0); 
        } else if (r.cat === 'Repair') {
            serviceExpense += (r.buy || 0);
            totalRevenue += (r.sell || 0);
        } else {
            totalRevenue += (r.sell || 0);
        }
    });

    // CALCULATE FROM INVENTORY
    inv.forEach(i => {
        currentInventoryValue += (i.buy * i.qty);
        totalStockInvested += (i.buy * (i.qty + (i.sold || 0)));
    });

    // MATH FOR SUMMARY
    let cashInHand = totalRevenue - generalExpense - serviceExpense;
    
    let costOfSoldItems = 0;
    filteredRecs.forEach(r => {
        if(r.cat !== 'Expense' && r.cat !== 'Repair') {
            costOfSoldItems += (r.buy || 0);
        }
    });

    let netProfit = totalRevenue - costOfSoldItems - generalExpense - serviceExpense;

    // 2. UPDATE TOP BOXES (The parts that were missing)
    document.getElementById('dash-sales').innerText = `$${totalRevenue.toFixed(2)}`;
    document.getElementById('dash-profit').innerText = `$${netProfit.toFixed(2)}`;

    // 3. YOUR ORIGINAL UI UPDATES (Stayed exactly the same)
    document.getElementById('fin-total-invest').innerText = `$${totalStockInvested.toFixed(2)}`;
    document.getElementById('fin-invest').innerText = `$${currentInventoryValue.toFixed(2)}`;
    document.getElementById('fin-serv-exp').innerText = `$${serviceExpense.toFixed(2)}`;
    document.getElementById('fin-gen-exp').innerText = `$${generalExpense.toFixed(2)}`;
    document.getElementById('fin-earn').innerText = `$${totalRevenue.toFixed(2)}`;
    document.getElementById('dash-cash').innerText = `$${cashInHand.toFixed(2)}`;
    document.getElementById('fin-net').innerText = `$${netProfit.toFixed(2)}`;
}

    function toggleReportMode() {
        reportViewMode = (reportViewMode === 'daily') ? 'range' : 'daily';
        document.getElementById('pager-daily').className = (reportViewMode === 'daily') ? 'pager-controls' : 'hidden';
        document.getElementById('pager-range').className = (reportViewMode === 'range') ? 'range-controls' : 'hidden';
        document.getElementById('pager-mode-title').innerText = (reportViewMode === 'daily') ? 'DAILY VIEW' : 'RANGE VIEW';
        refreshReportDisplay();
    }

    function changeReportDate(days) {
    const input = document.getElementById('report-date-input');
    const d = new Date(input.value);
    
    // Calculate the new date
    d.setDate(d.getDate() + days);
    const newDateStr = d.toISOString().split('T')[0];
    
    // Get Today's date
    const todayStr = new Date().toISOString().split('T')[0];

    // THE LOCK: Only update if the new date is NOT greater than today
    if (newDateStr <= todayStr) {
        input.value = newDateStr;
        refreshReportDisplay();
    } else {
        // Optional: you can show a small alert or just do nothing
        console.log("Cannot go beyond today");
    }
}

    function setReportFilter(f) {
    currentReportFilter = f;
    
    // 1. Clear shade from all buttons (Your original line)
    document.querySelectorAll('#records .sub-nav button').forEach(b => b.classList.remove('active'));
    
    // 2. Add this line to put the shade on the clicked button
    // It finds the button that was clicked and adds 'active' back to it
    event.currentTarget.classList.add('active');

    refreshReportDisplay();
}
    async function refreshReportDisplay() {
    let raw = await db.records.toArray();
    
    // 1. Filter by Date
    if(reportViewMode === 'daily') {
        const d = document.getElementById('report-date-input').value;
        raw = raw.filter(r => r.date === d);
    } else {
        const f = document.getElementById('rep-from').value;
        const t = document.getElementById('rep-to').value;
        if(f && t) raw = raw.filter(r => r.date >= f && r.date <= t);
    }

    // 2. Filter by Category
    if(currentReportFilter !== 'All') raw = raw.filter(r => r.cat === currentReportFilter);

    let rev = 0, prof = 0;
    
    // 3. Calculate Totals
    raw.forEach(r => {
        const isValid = (r.cat !== 'Pawn' || r.status === 'Collected');
        if(isValid) { rev += r.sell; prof += (r.sell - r.buy); }
    });

    document.getElementById('report-financial-summary').innerHTML = `
        <div style="display:flex; justify-content:space-between; font-size:16px;">
            <span>Revenue: $${rev.toFixed(2)}</span>
            <span>Profit: <b style="color:var(--success)">$${prof.toFixed(2)}</b></span>
        </div>
    `;

    // 4. Render Individual Cards (Removing Grouping to fix Delete)
    document.getElementById('report-items-list').innerHTML = raw.reverse().map(r => `
        <div class="card">
            <div style="display:flex; justify-content:space-between;">
                <div>
                    <b>${r.item}</b> ${r.qty > 1 ? '<small>(x'+r.qty+')</small>' : ''}<br>
                    <small>${r.cat} | ${r.date}</small>
                </div>
                <b>$${r.sell.toFixed(2)}</b>
            </div>
            <div class="control-panel">
                <button class="btn-delete" onclick="deleteRec(${r.id})">Delete</button>
            </div>
        </div>`).join('');
}

    async function deleteRec(id) {
    if(confirm("Delete this record permanently?")) { 
        // 1. GET THE RECORD DATA BEFORE DELETING (To see what was sold)
        const record = await db.records.get(id);
        
        if (record) {
            // 2. CHECK IF CATEGORY IS ACCESSORY OR PHONE
            if (record.cat === 'Accessory' || record.cat === 'Phone') {
                // 3. FIND THE ITEM IN INVENTORY (Stock Place)
                const inventoryItem = await db.inventory.where('name').equals(record.item).first();
                
                if (inventoryItem) {
                    // 4. REFILL THE STOCK (9 + 1 = 10)
                    const newQty = (inventoryItem.qty || 0) + (record.qty || 0);
                    await db.inventory.update(inventoryItem.id, { qty: newQty });
                }
            }
        }

        // 5. YOUR ORIGINAL CODE (Stays exactly the same)
        await db.records.delete(id); 
        refreshReportDisplay(); 
        refreshDashboardMetrics();
        syncToCloud();
    }
}
async function deleteStock(id) {
    if(confirm("Delete this item from inventory?")) {
        await db.inventory.delete(id);
        refreshInventoryDisplay();
        syncToCloud();
    }
}

async function modifyStock(id) {
    const item = await db.inventory.get(id);
    const newQty = prompt("Edit Quantity:", item.qty);
    const newSell = prompt("Edit Selling Price:", item.sell);
    const newBuy = prompt("Edit Buy Price (Cost):", item.buy);

    if (newQty !== null && newSell !== null && newBuy !== null) {
        await db.inventory.update(id, {
            qty: parseInt(newQty) || 0,
            sell: parseFloat(newSell) || 0,
            buy: parseFloat(newBuy) || 0
        });
        refreshInventoryDisplay();
        syncToCloud();
    }
}
    async function changeGlobalTab(tabID) {
    // THIS LINE JUMPS THE PAGE TO THE TOP IMMEDIATELY WHEN TAB CHANGES
    window.scrollTo(0, 0);

    document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
    document.getElementById(tabID).classList.remove('hidden');
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    
    const navMap = {dashboard:'das', 'sales-entry':'sal', inventory:'inv', records:'rec'};
    document.getElementById('btn-' + navMap[tabID]).classList.add('active');

    if(tabID === 'dashboard') refreshDashboardMetrics();
    
    if(tabID === 'records') {
        document.getElementById('report-date-input').value = getFormattedToday();
        document.getElementById('rep-from').value = getFormattedToday();
        document.getElementById('rep-to').value = getFormattedToday();
        refreshReportDisplay();
    }
    
    if(tabID === 'sales-entry') {
        document.getElementById('sale-date').value = getFormattedToday();
        const invItems = await db.inventory.toArray();
        document.getElementById('stock-datalist').innerHTML = invItems.map(i => `<option value="${i.name}">`).join('');
    }

    if(tabID === 'inventory') {
        switchInventorySubTab('acc');
    }
}

async function switchInventorySubTab(tab) {

    document.querySelectorAll('#inventory .sub-nav button').forEach(b => b.classList.remove('active'));

    // Ensure the button exists before adding active class

    const btn = document.getElementById('inv-tab-' + tab);

    if(btn) btn.classList.add('active');
    document.getElementById('inv-list-container').className = (tab === 'add') ? 'hidden' : '';
    document.getElementById('inv-add-container').className = (tab === 'add') ? '' : 'hidden';
    // This is the part that actually draws the list on screen
    if(tab !== 'add') refreshInventoryDisplay(tab);
}
    function generatePDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text("ELITE SHOP PRO BUSINESS REPORT", 20, 20);
        doc.text("Report Date: " + getFormattedToday(), 20, 30);
        doc.text("Total Net Profit: " + document.getElementById('fin-net').innerText, 20, 45);
        doc.save("EliteShop_Report.pdf");
    }

    changeGlobalTab('dashboard');
	// This prevents picking future dates from the calendar popup
document.getElementById('report-date-input').setAttribute('max', new Date().toISOString().split('T')[0]);
</script>
</body>
</html>
